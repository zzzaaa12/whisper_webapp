<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰€æœ‰æ‘˜è¦ç´€éŒ„ - Whisper å·¥å…·</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .list-group-item-action:hover {
            background-color: #e9ecef;
        }
        .summary-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #dee2e6;
        }
        .summary-item:last-child {
            border-bottom: none;
        }
        .summary-item:hover {
            background-color: #f8f9fa;
        }
        .summary-checkbox {
            margin-right: 1rem;
        }
        .summary-content {
            flex: 1;
            cursor: pointer;
        }
        .summary-content:hover {
            color: #0d6efd;
        }
        .batch-toolbar {
            background-color: #e9ecef;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #dee2e6;
            display: none;
        }
        .summary-meta {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        .channel-badge {
            background-color: #e9ecef;
            color: #495057;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }
        .filter-section {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .filter-row {
            display: flex;
            gap: 1rem;
            align-items: end;
        }
        .filter-item {
            flex: 1;
        }
        .filter-item label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: block;
        }
        .clear-filters {
            align-self: end;
        }

        /* æŒ‰éˆ•é¡è‰²èª¿æ•´ */
        .btn-outline-primary {
            background-color: #0d6efd; /* è—è‰²èƒŒæ™¯ */
            color: #ffffff !important; /* ç™½è‰²æ–‡å­— */
            border-color: #0d6efd;
        }

        .btn-warning {
            background-color: #ffc107; /* åŸæœ¬çš„é»ƒè‰²èƒŒæ™¯ä¿æŒ */
            color: #000000 !important; /* æ”¹æˆé»‘è‰²æ–‡å­— */
            border-color: #ffc107;
        }

        .btn-secondary {
            background-color: #6c757d; /* åŸæœ¬çš„ç°è‰²èƒŒæ™¯ä¿æŒ */
            color: #ffffff !important; /* ç™½è‰²æ–‡å­— */
            border-color: #6c757d;
        }

        /* hover æ•ˆæœ */
        .btn-outline-secondary.nav-bookmark-solid:hover {
            opacity: 0.8;
            color: #ffffff !important;
        }

        .btn-warning:hover {
            opacity: 0.8;
            color: #000000 !important;
        }

        .btn-secondary:hover {
            opacity: 0.8;
            color: #ffffff !important;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">æ‰€æœ‰æ‘˜è¦ç´€éŒ„</h1>
            <div class="btn-group">
                <a href="/trash" class="btn btn-warning">
                    <i class="bi bi-trash"></i> å›æ”¶æ¡¶
                </a>
                <a href="/bookmarks" class="btn btn-outline-secondary nav-bookmark-solid">
                    <i class="bi bi-bookmark-fill"></i> æ›¸ç±¤
                </a>
                <a href="{{ url_for('main.index') }}" class="btn btn-secondary">è¿”å›ä¸»é </a>
            </div>
        </div>

        <!-- éæ¿¾å™¨å€åŸŸ -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-item">
                    <label for="search-input">ğŸ” æœå°‹æ‘˜è¦</label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="form-control" id="search-input"
                               placeholder="æœå°‹æ‘˜è¦æª”æ¡ˆåç¨±..."
                               autocomplete="off">
                        <button class="btn btn-outline-secondary" type="button" id="clear-search">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
                <div class="filter-item">
                    <label for="channel-filter">ğŸ“º é »é“éæ¿¾</label>
                    <select class="form-select" id="channel-filter">
                        <option value="">å…¨éƒ¨é »é“</option>
                        {% for channel in channels %}
                        <option value="{{ channel }}">{{ channel }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="clear-filters">
                    <button class="btn btn-outline-secondary" type="button" id="clear-filters">
                        <i class="bi bi-arrow-clockwise"></i> æ¸…é™¤éæ¿¾
                    </button>
                </div>
            </div>
            <div class="mt-2">
                <small class="text-muted">
                    <span id="filter-status">é¡¯ç¤ºå…¨éƒ¨ {{ summaries|length }} å€‹æ‘˜è¦</span>
                </small>
            </div>
        </div>

        <!-- æ‰¹é‡æ“ä½œå·¥å…·åˆ— -->
        <div class="batch-toolbar" id="batch-toolbar">
            <div class="d-flex justify-content-between align-items-center">
                <span id="selected-count">å·²é¸æ“‡ 0 å€‹é …ç›®</span>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" id="batch-bookmark">
                        <i class="bi bi-bookmark-plus"></i> æ‰¹é‡æ›¸ç±¤
                    </button>
                    <button class="btn btn-sm btn-outline-danger" id="batch-delete">
                        <i class="bi bi-trash"></i> æ‰¹é‡åˆªé™¤
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="cancel-selection">
                        <i class="bi bi-x"></i> å–æ¶ˆé¸æ“‡
                    </button>
                </div>
            </div>
        </div>

        <!-- æ‘˜è¦åˆ—è¡¨ -->
        <div class="card">
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="summaries-list">
                    {% for summary in summaries %}
                    <div class="summary-item" data-filename="{{ summary.filename }}" data-channel="{{ summary.channel }}">
                        <input type="checkbox" class="form-check-input summary-checkbox"
                               data-filename="{{ summary.filename }}">
                        <div class="summary-content" onclick="window.location.href='/summary/{{ summary.filename }}'">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ summary.filename.replace('.txt', '') }}</h6>
                                    <div class="summary-meta">
                                        <span class="channel-badge">ğŸ“º {{ summary.channel }}</span>
                                        {% if summary.is_bookmarked %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="bi bi-bookmark-fill"></i> å·²æ›¸ç±¤
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary bookmark-btn"
                                            data-filename="{{ summary.filename }}"
                                            data-bookmarked="{{ summary.is_bookmarked|lower }}"
                                            onclick="event.stopPropagation();">
                                        <i class="bi {{ 'bi-bookmark-fill' if summary.is_bookmarked else 'bi-bookmark' }}"></i>
                                    </button>
                                    <a href="/download/summary/{{ summary.filename }}"
                                       class="btn btn-outline-primary"
                                       onclick="event.stopPropagation();">
                                        <i class="bi bi-download"></i>
                                    </a>
                                    <button class="btn btn-outline-danger delete-btn"
                                            data-filename="{{ summary.filename }}"
                                            onclick="event.stopPropagation();">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- ç„¡çµæœæç¤º -->
        <div class="card mt-3" id="no-results" style="display: none;">
            <div class="card-body text-center py-5">
                <i class="bi bi-search display-1 text-muted"></i>
                <h5 class="mt-3">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„æ‘˜è¦</h5>
                <p class="text-muted">è«‹å˜—è©¦èª¿æ•´æœå°‹æ¢ä»¶æˆ–é »é“éæ¿¾å™¨</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('search-input');
            const channelFilter = document.getElementById('channel-filter');
            const clearSearchBtn = document.getElementById('clear-search');
            const clearFiltersBtn = document.getElementById('clear-filters');
            const summariesList = document.getElementById('summaries-list');
            const noResults = document.getElementById('no-results');
            const filterStatus = document.getElementById('filter-status');
            const summaryItems = document.querySelectorAll('.summary-item');

            // éæ¿¾åŠŸèƒ½
            function filterSummaries() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedChannel = channelFilter.value;
                let visibleCount = 0;

                summaryItems.forEach(item => {
                    const filename = item.dataset.filename.toLowerCase();
                    const channel = item.dataset.channel;

                    const matchesSearch = !searchTerm || filename.includes(searchTerm);
                    const matchesChannel = !selectedChannel || channel === selectedChannel;

                    if (matchesSearch && matchesChannel) {
                        item.style.display = '';
                        visibleCount++;
                    } else {
                        item.style.display = 'none';
                    }
                });

                // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
                updateFilterStatus(visibleCount, searchTerm, selectedChannel);

                // é¡¯ç¤º/éš±è—ç„¡çµæœæç¤º
                if (visibleCount === 0) {
                    summariesList.style.display = 'none';
                    noResults.style.display = 'block';
                } else {
                    summariesList.style.display = 'block';
                    noResults.style.display = 'none';
                }
            }

            function updateFilterStatus(visibleCount, searchTerm, selectedChannel) {
                let statusText = `é¡¯ç¤º ${visibleCount} å€‹æ‘˜è¦`;

                if (searchTerm || selectedChannel) {
                    statusText += ' (å·²éæ¿¾)';
                    if (searchTerm) statusText += ` - æœå°‹: "${searchTerm}"`;
                    if (selectedChannel) statusText += ` - é »é“: "${selectedChannel}"`;
                }

                filterStatus.textContent = statusText;
            }

            // æ¸…é™¤éæ¿¾å™¨
            function clearFilters() {
                searchInput.value = '';
                channelFilter.value = '';
                filterSummaries();
            }

            // äº‹ä»¶ç›£è½å™¨
            searchInput.addEventListener('input', filterSummaries);
            channelFilter.addEventListener('change', filterSummaries);
            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                filterSummaries();
            });
            clearFiltersBtn.addEventListener('click', clearFilters);

            // æ›¸ç±¤åŠŸèƒ½
            document.querySelectorAll('.bookmark-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const filename = this.dataset.filename;
                    const isBookmarked = this.dataset.bookmarked === 'true';

                    fetch('/api/bookmark', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            filename: filename,
                            action: isBookmarked ? 'remove' : 'add'
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const icon = this.querySelector('i');
                            if (isBookmarked) {
                                icon.className = 'bi bi-bookmark';
                                this.dataset.bookmarked = 'false';
                            } else {
                                icon.className = 'bi bi-bookmark-fill';
                                this.dataset.bookmarked = 'true';
                            }

                            // æ›´æ–°æ‘˜è¦é …ç›®ä¸­çš„æ›¸ç±¤æ¨™è¨˜
                            const summaryItem = this.closest('.summary-item');
                            const bookmarkBadge = summaryItem.querySelector('.badge');
                            if (isBookmarked && bookmarkBadge) {
                                bookmarkBadge.remove();
                            } else if (!isBookmarked && !bookmarkBadge) {
                                const metaDiv = summaryItem.querySelector('.summary-meta');
                                const newBadge = document.createElement('span');
                                newBadge.className = 'badge bg-warning text-dark';
                                newBadge.innerHTML = '<i class="bi bi-bookmark-fill"></i> å·²æ›¸ç±¤';
                                metaDiv.appendChild(newBadge);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('æ›¸ç±¤æ“ä½œå¤±æ•—:', error);
                        alert('æ›¸ç±¤æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                    });
                });
            });

            // åˆªé™¤åŠŸèƒ½
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const filename = this.dataset.filename;

                    if (confirm(`ç¢ºå®šè¦åˆªé™¤æ‘˜è¦ "${filename}" å—ï¼Ÿ`)) {
                        fetch('/api/delete', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                filename: filename
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                this.closest('.summary-item').remove();
                                filterSummaries(); // é‡æ–°è¨ˆç®—é¡¯ç¤ºæ•¸é‡
                            } else {
                                alert('åˆªé™¤å¤±æ•—ï¼š' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('åˆªé™¤å¤±æ•—:', error);
                            alert('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                        });
                    }
                });
            });

            // æ‰¹é‡é¸æ“‡åŠŸèƒ½
            const checkboxes = document.querySelectorAll('.summary-checkbox');
            const batchToolbar = document.getElementById('batch-toolbar');
            const selectedCount = document.getElementById('selected-count');

            function updateBatchToolbar() {
                const checkedBoxes = document.querySelectorAll('.summary-checkbox:checked');
                const count = checkedBoxes.length;

                if (count > 0) {
                    batchToolbar.style.display = 'block';
                    selectedCount.textContent = `å·²é¸æ“‡ ${count} å€‹é …ç›®`;
                } else {
                    batchToolbar.style.display = 'none';
                }
            }

            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateBatchToolbar);
            });

            // å–æ¶ˆé¸æ“‡
            document.getElementById('cancel-selection').addEventListener('click', function() {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                updateBatchToolbar();
            });

            // æ‰¹é‡æ›¸ç±¤
            document.getElementById('batch-bookmark').addEventListener('click', function() {
                const checkedBoxes = document.querySelectorAll('.summary-checkbox:checked');
                const filenames = Array.from(checkedBoxes).map(cb => cb.dataset.filename);

                if (filenames.length === 0) return;

                fetch('/api/batch-bookmark', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filenames: filenames,
                        action: 'add'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(); // ç°¡å–®é‡æ–°è¼‰å…¥é é¢
                    } else {
                        alert('æ‰¹é‡æ›¸ç±¤æ“ä½œå¤±æ•—ï¼š' + data.message);
                    }
                })
                .catch(error => {
                    console.error('æ‰¹é‡æ›¸ç±¤æ“ä½œå¤±æ•—:', error);
                    alert('æ‰¹é‡æ›¸ç±¤æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                });
            });

            // æ‰¹é‡åˆªé™¤
            document.getElementById('batch-delete').addEventListener('click', function() {
                const checkedBoxes = document.querySelectorAll('.summary-checkbox:checked');
                const filenames = Array.from(checkedBoxes).map(cb => cb.dataset.filename);

                if (filenames.length === 0) return;

                if (confirm(`ç¢ºå®šè¦åˆªé™¤é¸ä¸­çš„ ${filenames.length} å€‹æ‘˜è¦å—ï¼Ÿ`)) {
                    fetch('/api/batch-delete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            filenames: filenames
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload(); // ç°¡å–®é‡æ–°è¼‰å…¥é é¢
                        } else {
                            alert('æ‰¹é‡åˆªé™¤æ“ä½œå¤±æ•—ï¼š' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('æ‰¹é‡åˆªé™¤æ“ä½œå¤±æ•—:', error);
                        alert('æ‰¹é‡åˆªé™¤æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                    });
                }
            });
        });
    </script>
</body>
</html>