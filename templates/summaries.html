<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰€æœ‰æ‘˜è¦ç´€éŒ„ - Whisper å·¥å…·</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }

        /* Desktop Styles */
        .desktop-view .summary-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #dee2e6;
        }
        .desktop-view .summary-item:last-child {
            border-bottom: none;
        }
        .desktop-view .summary-item:hover {
            background-color: #f8f9fa;
        }
        .desktop-view .summary-checkbox {
            margin-right: 1rem;
        }
        .desktop-view .summary-content {
            flex: 1;
            cursor: pointer;
        }
        .desktop-view .summary-content:hover {
            color: #0d6efd;
        }
        .desktop-view .batch-toolbar {
            background-color: #e9ecef;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #dee2e6;
            display: none;
        }
        .desktop-view .summary-meta {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        .desktop-view .channel-badge {
            background-color: #e7f3ff;
            color: #0366d6;
            border: 1px solid #c8e1ff;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            margin-right: 0.5rem;
        }
        .desktop-view .summary-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .desktop-view .btn-group .btn {
            white-space: nowrap;
        }
        .desktop-view .filter-section {
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .desktop-view .bookmark-badge {
            background-color: #ffc107;
            color: #000;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }

        /* Mobile Styles */
        .mobile-view {
            display: none;
        }

        .mobile-view .simple-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 1rem;
        }

        .mobile-view .summary-count {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .mobile-view .simple-filter {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 0.5rem 0;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
        }

        .mobile-view .hidden-nav,
        .mobile-view .hidden-search {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            animation: slideDown 0.3s ease;
            display: none;
        }

        .mobile-view .nav-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .mobile-view .summary-item {
            margin-bottom: 0.75rem;
            padding: 0;
            border: 1px solid #e9ecef;
            border-radius: 0.5rem;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }

        .mobile-view .summary-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .mobile-view .summary-checkbox {
            position: absolute;
            top: 1rem;
            left: 1rem;
            transform: scale(1.3);
            z-index: 10;
            display: none;
        }

        .mobile-view .summary-content {
            padding: 1rem;
            cursor: pointer;
        }

        .mobile-view .summary-content h6 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            line-height: 1.4;
            color: #2c3e50;
        }

        .mobile-view .summary-meta {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .mobile-view .channel-badge {
            background-color: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 500;
            width: fit-content;
        }

        .mobile-view .summary-item.bookmarked {
            border-color: #ffc107;
            border-width: 2px;
        }

        .mobile-view .summary-item.bookmarked::before {
            content: "\f4a5";
            font-family: "Bootstrap Icons";
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: #ffc107;
            font-size: 1.2rem;
            z-index: 5;
        }

        /* Floating Action Button */
        .floating-actions {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: none;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: #007bff;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .fab:hover {
            background: #0056b3;
            transform: scale(1.1);
        }

        .fab-menu.active .fab-main {
            background: #dc3545;
            transform: rotate(45deg);
        }

        .fab-actions {
            position: absolute;
            bottom: 0;
            right: 0;
            display: flex;
            flex-direction: column-reverse;
            gap: 12px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .fab-menu.active .fab-actions {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(-68px);
        }

        .fab-action {
            width: 48px;
            height: 48px;
            font-size: 1rem;
            background: #6c757d;
            transform: scale(0);
            animation: fabScale 0.3s ease forwards;
        }

        .fab-action:nth-child(1) { animation-delay: 0.1s; }
        .fab-action:nth-child(2) { animation-delay: 0.2s; }
        .fab-action:nth-child(3) { animation-delay: 0.3s; }

        @keyframes fabScale {
            to {
                transform: scale(1);
            }
        }

        /* Mobile batch toolbar */
        .mobile-batch-toolbar {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            z-index: 1000;
            border-radius: 25px;
            padding: 1rem 1.5rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            display: none;
        }

        /* Media Queries */
        @media (max-width: 768px) {
            .desktop-view {
                display: none !important;
            }
            .mobile-view {
                display: block !important;
            }
            .floating-actions {
                display: block;
            }
            body.batch-mode .mobile-view .summary-checkbox {
                display: block;
            }
            body.batch-mode {
                padding-bottom: 100px;
            }
        }

        @media (min-width: 769px) {
            .mobile-view {
                display: none !important;
            }
            .desktop-view {
                display: block !important;
            }
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Desktop View -->
        <div class="desktop-view">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1 class="h3 mb-0">æ‰€æœ‰æ‘˜è¦ç´€éŒ„</h1>
                <span class="text-muted">å…± {{ summaries|length }} å€‹æ‘˜è¦</span>
            </div>

            <!-- æ‰¹é‡å·¥å…·åˆ— -->
            <div class="batch-toolbar" id="desktop-batch-toolbar">
                <div class="d-flex justify-content-between align-items-center">
                    <span id="desktop-selected-count">å·²é¸æ“‡ 0 å€‹é …ç›®</span>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary" id="desktop-batch-bookmark">
                            <i class="bi bi-bookmark-plus"></i> æ‰¹é‡æ›¸ç±¤
                        </button>
                        <button class="btn btn-sm btn-outline-danger" id="desktop-batch-delete">
                            <i class="bi bi-trash"></i> æ‰¹é‡åˆªé™¤
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="desktop-cancel-selection">
                            <i class="bi bi-x"></i> å–æ¶ˆé¸æ“‡
                        </button>
                    </div>
                </div>
            </div>

            <!-- å°èˆªæŒ‰éˆ• -->
            <div class="mb-3">
                <div class="btn-group">
                    <a href="/trash" class="btn btn-warning">
                        <i class="bi bi-trash"></i> å›æ”¶æ¡¶
                    </a>
                    <a href="/bookmarks" class="btn btn-outline-secondary nav-bookmark-solid">
                        <i class="bi bi-bookmark-fill"></i> æ›¸ç±¤
                    </a>
                    <a href="{{ url_for('main.index') }}" class="btn btn-secondary">è¿”å›ä¸»é </a>
                </div>
            </div>

            <!-- éæ¿¾å™¨å€åŸŸ -->
            <div class="filter-section">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="desktop-channel-filter" class="form-label">é »é“éæ¿¾</label>
                        <select class="form-select" id="desktop-channel-filter">
                            <option value="">å…¨éƒ¨é »é“ ({{ summaries|length }})</option>
                            {% for channel in channels %}
                            <option value="{{ channel }}">{{ channel }} ({{ channel_counts[channel] }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="desktop-search-input" class="form-label">æœå°‹</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" class="form-control" id="desktop-search-input" placeholder="æœå°‹æ‘˜è¦æ¨™é¡Œ...">
                            <button class="btn btn-outline-secondary" type="button" id="desktop-clear-search">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button class="btn btn-outline-secondary w-100" type="button" id="desktop-clear-filters">
                                <i class="bi bi-arrow-clockwise"></i> é‡ç½®
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-muted" id="desktop-filter-status">é¡¯ç¤ºå…¨éƒ¨ {{ summaries|length }} å€‹æ‘˜è¦</small>
                </div>
            </div>

            <!-- æ‘˜è¦åˆ—è¡¨ -->
            <div class="card">
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="desktop-summaries-list">
                        {% for summary in summaries %}
                        <div class="summary-item" data-filename="{{ summary.filename }}" data-title="{{ summary.title }}" data-channel="{{ summary.channel }}" data-bookmarked="{{ summary.is_bookmarked|lower }}">
                            <input type="checkbox" class="form-check-input summary-checkbox" data-filename="{{ summary.filename }}">
                            <div class="summary-content" onclick="window.location.href='/summary/{{ summary.filename }}'">
                                <h6 class="mb-1">{{ summary.title }}</h6>
                                <div class="summary-meta">
                                    <span class="channel-badge">{{ summary.channel }}</span>
                                    {% if summary.is_bookmarked %}
                                    <span class="bookmark-badge">
                                        <i class="bi bi-bookmark-fill"></i> å·²æ›¸ç±¤
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="summary-actions">
                                <button class="btn btn-sm btn-outline-primary bookmark-toggle" data-filename="{{ summary.filename }}">
                                    <i class="bi bi-bookmark{{ '-fill' if summary.is_bookmarked else '' }}"></i>
                                </button>
                                <a href="/download/summary/{{ summary.filename }}" class="btn btn-sm btn-outline-success">
                                    <i class="bi bi-download"></i>
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- ç„¡çµæœæç¤º -->
            <div class="card mt-3" id="desktop-no-results" style="display: none;">
                <div class="card-body text-center py-5">
                    <i class="bi bi-search display-1 text-muted"></i>
                    <h5 class="mt-3">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„æ‘˜è¦</h5>
                    <p class="text-muted">è«‹å˜—è©¦èª¿æ•´æœå°‹æ¢ä»¶æˆ–é »é“éæ¿¾å™¨</p>
                </div>
            </div>
        </div>

        <!-- Mobile View -->
        <div class="mobile-view">
            <div class="simple-header mb-3">
                <h1 class="h4 mb-0">æ‘˜è¦åˆ—è¡¨</h1>
                <span class="summary-count">å…± {{ summaries|length }} å€‹æ‘˜è¦</span>
            </div>

            <!-- éš±è—çš„å°èˆªå€åŸŸ -->
            <div class="hidden-nav" id="mobile-hidden-nav">
                <div class="nav-buttons mb-3">
                    <a href="{{ url_for('main.index') }}" class="btn btn-primary btn-sm">
                        <i class="bi bi-house"></i> é¦–é 
                    </a>
                    <a href="/queue" class="btn btn-info btn-sm">
                        <i class="bi bi-list-task"></i> ä»»å‹™ä½‡åˆ—
                    </a>
                    <a href="/trash" class="btn btn-warning btn-sm">
                        <i class="bi bi-trash"></i> å›æ”¶æ¡¶
                    </a>
                    <a href="/bookmarks" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-bookmark-fill"></i> æ›¸ç±¤
                    </a>
                </div>
            </div>

            <!-- ç°¡åŒ–çš„éæ¿¾å™¨ -->
            <div class="simple-filter mb-3">
                <select class="form-select" id="mobile-channel-filter">
                    <option value="">ğŸ“º å…¨éƒ¨é »é“ ({{ summaries|length }})</option>
                    {% for channel in channels %}
                    <option value="{{ channel }}">{{ channel }} ({{ channel_counts[channel] }})</option>
                    {% endfor %}
                </select>
            </div>

            <!-- éš±è—çš„æœå°‹å€åŸŸ -->
            <div class="hidden-search" id="mobile-hidden-search">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" class="form-control" id="mobile-search-input" placeholder="æœå°‹æ‘˜è¦æ¨™é¡Œ...">
                    <button class="btn btn-outline-secondary" type="button" id="mobile-clear-search">
                        <i class="bi bi-x-lg"></i>
                    </button>
                    <button class="btn btn-outline-secondary" type="button" id="mobile-clear-filters">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="mt-2">
                    <small class="text-muted" id="mobile-filter-status">é¡¯ç¤ºå…¨éƒ¨ {{ summaries|length }} å€‹æ‘˜è¦</small>
                </div>
            </div>

            <!-- æ‘˜è¦åˆ—è¡¨ -->
            <div class="card">
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="mobile-summaries-list">
                        {% for summary in summaries %}
                        <div class="summary-item{{ ' bookmarked' if summary.is_bookmarked else '' }}" data-filename="{{ summary.filename }}" data-channel="{{ summary.channel }}" data-bookmarked="{{ summary.is_bookmarked|lower }}">
                            <input type="checkbox" class="form-check-input summary-checkbox" data-filename="{{ summary.filename }}">
                            <div class="summary-content" onclick="window.location.href='/summary/{{ summary.filename }}'">
                                <h6 class="mb-1">{{ summary.title }}</h6>
                                <div class="summary-meta">
                                    <span class="channel-badge">ğŸ“º {{ summary.channel }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- ç„¡çµæœæç¤º -->
            <div class="card mt-3" id="mobile-no-results" style="display: none;">
                <div class="card-body text-center py-5">
                    <i class="bi bi-search display-1 text-muted"></i>
                    <h5 class="mt-3">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„æ‘˜è¦</h5>
                    <p class="text-muted">è«‹å˜—è©¦èª¿æ•´æœå°‹æ¢ä»¶æˆ–é »é“éæ¿¾å™¨</p>
                </div>
            </div>
        </div>

        <!-- æ‡¸æµ®åŠŸèƒ½æŒ‰éˆ•çµ„ (Mobile Only) -->
        <div class="floating-actions">
            <div class="fab-menu" id="fab-menu">
                <button class="fab fab-main" id="fab-main" title="æ›´å¤šåŠŸèƒ½">
                    <i class="bi bi-three-dots"></i>
                </button>
                <div class="fab-actions">
                    <button class="fab fab-action" id="toggle-search" title="æœå°‹æ‘˜è¦">
                        <i class="bi bi-search"></i>
                    </button>
                    <button class="fab fab-action" id="toggle-nav" title="å°èˆªé¸å–®">
                        <i class="bi bi-menu-button"></i>
                    </button>
                    <button class="fab fab-action" id="toggle-batch" title="æ‰¹é‡æ“ä½œ">
                        <i class="bi bi-check2-square"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- æ‰‹æ©Ÿç‰ˆæ‰¹é‡æ“ä½œå·¥å…·åˆ— -->
        <div class="mobile-batch-toolbar" id="mobile-batch-toolbar">
            <div class="d-flex justify-content-between align-items-center">
                <span id="mobile-selected-count">å·²é¸æ“‡ 0 å€‹é …ç›®</span>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" id="mobile-batch-bookmark">
                        <i class="bi bi-bookmark-plus"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="mobile-cancel-selection">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const isMobile = window.innerWidth <= 768;
            const prefix = isMobile ? 'mobile' : 'desktop';

            // Get elements with proper prefix
            const searchInput = document.getElementById(prefix + '-search-input');
            const channelFilter = document.getElementById(prefix + '-channel-filter');
            const summariesList = document.getElementById(prefix + '-summaries-list');
            const noResults = document.getElementById(prefix + '-no-results');
            const filterStatus = document.getElementById(prefix + '-filter-status');
            const clearSearchBtn = document.getElementById(prefix + '-clear-search');
            const clearFiltersBtn = document.getElementById(prefix + '-clear-filters');

            // Mobile-specific elements
            if (isMobile) {
                // Titles are now cleaned on the server side, no need for client-side processing

                const hiddenSearch = document.getElementById('mobile-hidden-search');
                const hiddenNav = document.getElementById('mobile-hidden-nav');
                const fabMenu = document.getElementById('fab-menu');
                const fabMain = document.getElementById('fab-main');
                const toggleSearch = document.getElementById('toggle-search');
                const toggleNav = document.getElementById('toggle-nav');
                const toggleBatch = document.getElementById('toggle-batch');

                let isMenuOpen = false;

                // FAB functionality
                fabMain.addEventListener('click', function() {
                    isMenuOpen = !isMenuOpen;
                    fabMenu.classList.toggle('active', isMenuOpen);

                    if (!isMenuOpen) {
                        hiddenSearch.style.display = 'none';
                        hiddenNav.style.display = 'none';
                    }
                });

                toggleSearch.addEventListener('click', function() {
                    const isVisible = hiddenSearch.style.display !== 'none';
                    hiddenSearch.style.display = isVisible ? 'none' : 'block';
                    hiddenNav.style.display = 'none';
                    closeFabMenu();
                });

                toggleNav.addEventListener('click', function() {
                    const isVisible = hiddenNav.style.display !== 'none';
                    hiddenNav.style.display = isVisible ? 'none' : 'block';
                    hiddenSearch.style.display = 'none';
                    closeFabMenu();
                });

                toggleBatch.addEventListener('click', function() {
                    enableBatchMode();
                    closeFabMenu();
                });

                function closeFabMenu() {
                    isMenuOpen = false;
                    fabMenu.classList.remove('active');
                }

                function enableBatchMode() {
                    document.body.classList.add('batch-mode');
                    document.querySelectorAll('.mobile-view .summary-checkbox').forEach(checkbox => {
                        checkbox.style.display = 'block';
                    });
                }
            }

            // Filter functionality
            function filterSummaries() {
                if (!searchInput || !channelFilter) return;

                const searchTerm = searchInput.value.toLowerCase();
                const selectedChannel = channelFilter.value;
                let visibleCount = 0;

                const summaryItems = document.querySelectorAll((isMobile ? '.mobile-view' : '.desktop-view') + ' .summary-item');

                summaryItems.forEach(item => {
                    const title = item.dataset.title ? item.dataset.title.toLowerCase() : item.dataset.filename.toLowerCase();
                    const channel = item.dataset.channel;

                    const matchesSearch = !searchTerm || title.includes(searchTerm);
                    const matchesChannel = !selectedChannel || channel === selectedChannel;

                    if (matchesSearch && matchesChannel) {
                        item.style.display = '';
                        visibleCount++;
                    } else {
                        item.style.display = 'none';
                    }
                });

                // Update status
                if (filterStatus) {
                    let statusText = `é¡¯ç¤º ${visibleCount} å€‹æ‘˜è¦`;
                    if (searchTerm || selectedChannel) {
                        statusText += ' (å·²éæ¿¾)';
                    }
                    filterStatus.textContent = statusText;
                }

                // Show/hide no results
                if (noResults) {
                    if (visibleCount === 0) {
                        summariesList.style.display = 'none';
                        noResults.style.display = 'block';
                    } else {
                        summariesList.style.display = 'block';
                        noResults.style.display = 'none';

                        // No need for title cleaning - handled server-side
                    }
                }
            }

            // Event listeners for filtering
            if (searchInput) searchInput.addEventListener('input', filterSummaries);
            if (channelFilter) channelFilter.addEventListener('change', filterSummaries);
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', function() {
                    if (searchInput) {
                        searchInput.value = '';
                        filterSummaries();
                    }
                });
            }
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', function() {
                    if (searchInput) searchInput.value = '';
                    if (channelFilter) channelFilter.value = '';
                    filterSummaries();
                });
            }

            // Batch selection functionality
            const checkboxes = document.querySelectorAll('.summary-checkbox');
            const batchToolbar = document.getElementById(prefix + '-batch-toolbar');
            const selectedCount = document.getElementById(prefix + '-selected-count');
            const cancelSelection = document.getElementById(prefix + '-cancel-selection');
            const batchBookmark = document.getElementById(prefix + '-batch-bookmark');

            function updateBatchToolbar() {
                const checkedBoxes = document.querySelectorAll('.summary-checkbox:checked');
                const count = checkedBoxes.length;

                if (batchToolbar && selectedCount) {
                    if (count > 0) {
                        batchToolbar.style.display = 'block';
                        selectedCount.textContent = `å·²é¸æ“‡ ${count} å€‹é …ç›®`;
                        if (isMobile) {
                            document.body.classList.add('batch-mode');
                        }
                    } else {
                        batchToolbar.style.display = 'none';
                        if (isMobile) {
                            document.body.classList.remove('batch-mode');
                            // Hide checkboxes
                            document.querySelectorAll('.mobile-view .summary-checkbox').forEach(checkbox => {
                                checkbox.style.display = 'none';
                                checkbox.checked = false;
                            });
                        }
                    }
                }
            }

            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateBatchToolbar);
            });

            if (cancelSelection) {
                cancelSelection.addEventListener('click', function() {
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    updateBatchToolbar();
                });
            }

            // Bookmark functionality
            document.querySelectorAll('.bookmark-toggle').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const filename = this.dataset.filename;
                    const icon = this.querySelector('i');
                    const isBookmarked = icon.classList.contains('bi-bookmark-fill');

                    fetch('/api/bookmark', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            filename: filename,
                            action: isBookmarked ? 'remove' : 'add'
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            if (isBookmarked) {
                                icon.classList.replace('bi-bookmark-fill', 'bi-bookmark');
                            } else {
                                icon.classList.replace('bi-bookmark', 'bi-bookmark-fill');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('æ›¸ç±¤æ“ä½œå¤±æ•—:', error);
                    });
                });
            });

            // Batch bookmark functionality
            if (batchBookmark) {
                batchBookmark.addEventListener('click', function() {
                    const checkedBoxes = document.querySelectorAll('.summary-checkbox:checked');
                    const filenames = Array.from(checkedBoxes).map(cb => cb.dataset.filename);

                    if (filenames.length === 0) return;

                    fetch('/api/batch-bookmark', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            filenames: filenames,
                            action: 'add'
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('æ‰¹é‡æ›¸ç±¤æ“ä½œå¤±æ•—ï¼š' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('æ‰¹é‡æ›¸ç±¤æ“ä½œå¤±æ•—:', error);
                        alert('æ‰¹é‡æ›¸ç±¤æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                    });
                });
            }
        });
    </script>
</body>
</html>