{% extends "base.html" %}

{% block title %}æ‰€æœ‰æ‘˜è¦ç´€éŒ„ - Whisper Web App{% endblock %}

{% block head %}
<!-- OpenCC.js for Traditional Chinese conversion -->
<script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js"></script>
<style>
    /* Desktop Styles */
    .desktop-view .summary-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--border-color);
    }
    .desktop-view .summary-item:last-child {
        border-bottom: none;
    }
    .desktop-view .summary-item:hover {
        background-color: var(--bg-secondary);
    }
    .desktop-view .summary-checkbox {
        margin-right: 1rem;
    }
    .desktop-view .summary-content {
        flex: 1;
        cursor: pointer;
    }
    .desktop-view .summary-content:hover {
        color: #0d6efd;
    }
    .desktop-view .batch-toolbar {
        background-color: var(--bg-secondary);
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--border-color);
        display: none;
    }
    .desktop-view .summary-meta {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }
    .desktop-view .summary-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    .desktop-view .btn-group .btn {
        white-space: nowrap;
    }
    .desktop-view .filter-section {
        background-color: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    /* å¿«é€Ÿé »é“éæ¿¾æ¨™ç±¤æ¨£å¼ */
    .channel-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    .channel-chip {
        border: 2px solid var(--border-color);
        background-color: var(--bg-card);
        padding: 0.5rem 1rem;
        border-radius: 1.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        color: var(--text-primary);
    }
    .channel-chip:hover {
        border-color: #0d6efd;
        background-color: var(--bg-secondary);
        transform: translateY(-2px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .channel-chip.active {
        border-color: #0d6efd;
        background-color: #0d6efd;
        color: white;
    }
    .channel-chip .badge {
        font-size: 0.75rem;
    }
    .channel-chip.active .badge {
        background-color: rgba(255,255,255,0.3) !important;
    }

    /* Mobile Styles */
    .mobile-view {
        display: none;
    }

    .mobile-view .simple-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 1rem;
    }

    .mobile-view .summary-count {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .mobile-view .hidden-nav,
    .mobile-view .hidden-search {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        animation: slideDown 0.3s ease;
        display: none;
    }

    .mobile-view .nav-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .mobile-view .summary-item {
        margin-bottom: 0.75rem;
        padding: 0;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        background: var(--bg-card);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        position: relative;
    }

    .mobile-view .summary-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .mobile-view .summary-checkbox {
        position: absolute;
        top: 1rem;
        left: 1rem;
        transform: scale(1.3);
        z-index: 10;
        display: none;
    }

    .mobile-view .summary-content {
        padding: 1rem;
        cursor: pointer;
    }

    .mobile-view .summary-content h6 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        line-height: 1.4;
        color: var(--text-primary);
    }

    .mobile-view .summary-meta {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .mobile-view .summary-item.bookmarked {
        border-color: #ffc107;
        border-width: 2px;
    }

    .mobile-view .summary-item.bookmarked::before {
        content: "\f4a5";
        font-family: "Bootstrap Icons";
        position: absolute;
        top: 1rem;
        right: 1rem;
        color: #ffc107;
        font-size: 1.2rem;
        z-index: 5;
    }

    /* Floating Action Button */
    .floating-actions {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        display: none;
    }

    .fab {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        border: none;
        background: #007bff;
        color: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .fab:hover {
        background: #0056b3;
        transform: scale(1.1);
    }

    .fab-menu.active .fab-main {
        background: #dc3545;
        transform: rotate(45deg);
    }

    .fab-actions {
        position: absolute;
        bottom: 0;
        right: 0;
        display: flex;
        flex-direction: column-reverse;
        gap: 12px;
        opacity: 0;
        pointer-events: none;
        transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .fab-menu.active .fab-actions {
        opacity: 1;
        pointer-events: auto;
        transform: translateY(-68px);
    }

    .fab-action {
        width: 48px;
        height: 48px;
        font-size: 1rem;
        background: #6c757d;
        transform: scale(0);
        animation: fabScale 0.3s ease forwards;
    }

    .fab-action:nth-child(1) { animation-delay: 0.1s; }
    .fab-action:nth-child(2) { animation-delay: 0.2s; }
    .fab-action:nth-child(3) { animation-delay: 0.3s; }

    @keyframes fabScale {
        to {
            transform: scale(1);
        }
    }

    /* Mobile batch toolbar */
    .mobile-batch-toolbar {
        position: fixed;
        bottom: 20px;
        left: 20px;
        right: 20px;
        z-index: 1000;
        border-radius: 25px;
        padding: 1rem 1.5rem;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        display: none;
    }

    [data-theme="dark"] .mobile-batch-toolbar {
        background: rgba(22, 27, 34, 0.95);
    }

    /* Media Queries */
    @media (max-width: 768px) {
        .desktop-view {
            display: none !important;
        }
        .mobile-view {
            display: block !important;
        }
        .floating-actions {
            display: block;
        }
        body.batch-mode .mobile-view .summary-checkbox {
            display: block;
        }
        body.batch-mode {
            padding-bottom: 100px;
        }
    }

    @media (min-width: 769px) {
        .mobile-view {
            display: none !important;
        }
        .desktop-view {
            display: block !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <h1>æ‰€æœ‰æ‘˜è¦ç´€éŒ„</h1>
    <p class="page-description">å…± {{ summaries|length }} å€‹æ‘˜è¦</p>
</div>

<!-- Desktop View -->
<div class="desktop-view">
    <!-- æ‰¹é‡å·¥å…·åˆ— -->
    <div class="batch-toolbar" id="desktop-batch-toolbar">
        <div class="d-flex justify-content-between align-items-center">
            <span id="desktop-selected-count">å·²é¸æ“‡ 0 å€‹é …ç›®</span>
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" id="desktop-batch-bookmark">
                    <i class="bi bi-bookmark-plus"></i> æ‰¹é‡æ›¸ç±¤
                </button>
                <button class="btn btn-sm btn-outline-danger" id="desktop-batch-delete">
                    <i class="bi bi-trash"></i> æ‰¹é‡åˆªé™¤
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="desktop-cancel-selection">
                    <i class="bi bi-x"></i> å–æ¶ˆé¸æ“‡
                </button>
            </div>
        </div>
    </div>

    <!-- éæ¿¾å™¨å€åŸŸ -->
    <div class="filter-section">
        <!-- å¿«é€Ÿé »é“éæ¿¾æ¨™ç±¤ -->
        <div class="mb-3">
            <label class="form-label">å¿«é€Ÿé »é“ç¯©é¸ (å‰20å€‹ç†±é–€é »é“)</label>
            <div class="channel-chips d-flex flex-wrap gap-2">
                <button class="channel-chip active" data-channel="">
                    ğŸ“º å…¨éƒ¨é »é“ <span class="badge bg-primary ms-1">{{ summaries|length }}</span>
                </button>
                {% for channel in top_channels %}
                <button class="channel-chip" data-channel="{{ channel_original_names.get(channel, channel) }}">
                    {{ channel }} <span class="badge bg-secondary ms-1">{{ channel_counts[channel] }}</span>
                </button>
                {% endfor %}
            </div>
        </div>

        <div class="row g-3">
            <div class="col-md-4">
                <label for="desktop-channel-filter" class="form-label">é »é“éæ¿¾</label>
                <select class="form-select" id="desktop-channel-filter">
                    <option value="">å…¨éƒ¨é »é“ ({{ summaries|length }})</option>
                    {% for channel in channels %}
                    <option value="{{ channel_original_names.get(channel, channel) }}">{{ channel }} ({{ channel_counts[channel] }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label for="desktop-search-input" class="form-label">æœå°‹</label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" class="form-control" id="desktop-search-input" placeholder="æœå°‹æ‘˜è¦æ¨™é¡Œ...">
                    <button class="btn btn-outline-secondary" type="button" id="desktop-clear-search">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button class="btn btn-outline-secondary w-100" type="button" id="desktop-clear-filters">
                        <i class="bi bi-arrow-clockwise"></i> é‡ç½®
                    </button>
                </div>
            </div>
        </div>
        <div class="mt-2">
            <small class="text-muted" id="desktop-filter-status">é¡¯ç¤ºå…¨éƒ¨ {{ summaries|length }} å€‹æ‘˜è¦</small>
        </div>
    </div>

    <!-- æ‘˜è¦åˆ—è¡¨ -->
    <div class="card">
        <div class="card-body p-0">
            <div class="list-group list-group-flush" id="desktop-summaries-list">
                {% for summary in summaries %}
                <div class="summary-item" data-filename="{{ summary.filename }}" data-title="{{ summary.title }}" data-channel="{{ summary.channel }}" data-bookmarked="{{ summary.is_bookmarked|lower }}">
                    <input type="checkbox" class="form-check-input summary-checkbox" data-filename="{{ summary.filename }}">
                    <div class="summary-content" onclick="window.location.href='/summary/{{ summary.filename }}'">
                        <h6 class="mb-1">{{ summary.title }}</h6>
                        <div class="summary-meta">
                            <span class="badge-channel">{{ summary.channel_display }}</span>
                            {% if summary.is_bookmarked %}
                            <span class="badge-bookmark">
                                <i class="bi bi-bookmark-fill"></i> å·²æ›¸ç±¤
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="summary-actions">
                        <button class="btn btn-sm btn-outline-primary bookmark-toggle" data-filename="{{ summary.filename }}">
                            <i class="bi bi-bookmark{{ '-fill' if summary.is_bookmarked else '' }}"></i>
                        </button>
                        <a href="/download/summary/{{ summary.filename }}" class="btn btn-sm btn-outline-success">
                            <i class="bi bi-download"></i>
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- ç„¡çµæœæç¤º -->
    <div class="empty-state" id="desktop-no-results" style="display: none;">
        <i class="bi bi-search"></i>
        <h3>æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„æ‘˜è¦</h3>
        <p>è«‹å˜—è©¦èª¿æ•´æœå°‹æ¢ä»¶æˆ–é »é“éæ¿¾å™¨</p>
    </div>
</div>

<!-- Mobile View -->
<div class="mobile-view">
    <div class="simple-header mb-3">
        <h1 class="h4 mb-0">æ‘˜è¦åˆ—è¡¨</h1>
        <span class="summary-count">å…± {{ summaries|length }} å€‹æ‘˜è¦</span>
    </div>

    <!-- å¿«é€Ÿé »é“éæ¿¾æ¨™ç±¤ (æ‰‹æ©Ÿç‰ˆ) -->
    <div class="mb-3">
        <div class="channel-chips d-flex flex-wrap gap-2">
            <button class="channel-chip active" data-channel="">
                ğŸ“º å…¨éƒ¨ <span class="badge bg-primary ms-1">{{ summaries|length }}</span>
            </button>
            {% for channel in top_channels %}
            <button class="channel-chip" data-channel="{{ channel_original_names.get(channel, channel) }}">
                {{ channel }} <span class="badge bg-secondary ms-1">{{ channel_counts[channel] }}</span>
            </button>
            {% endfor %}
        </div>
    </div>

    <!-- éš±è—çš„æœå°‹å€åŸŸ -->
    <div class="hidden-search" id="mobile-hidden-search">
        <div class="input-group">
            <span class="input-group-text">
                <i class="bi bi-search"></i>
            </span>
            <input type="text" class="form-control" id="mobile-search-input" placeholder="æœå°‹æ‘˜è¦æ¨™é¡Œ...">
            <button class="btn btn-outline-secondary" type="button" id="mobile-clear-search">
                <i class="bi bi-x-lg"></i>
            </button>
            <button class="btn btn-outline-secondary" type="button" id="mobile-clear-filters">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
        <div class="mt-2">
            <small class="text-muted" id="mobile-filter-status">é¡¯ç¤ºå…¨éƒ¨ {{ summaries|length }} å€‹æ‘˜è¦</small>
        </div>
    </div>

    <!-- æ‘˜è¦åˆ—è¡¨ -->
    <div class="card">
        <div class="card-body p-0">
            <div class="list-group list-group-flush" id="mobile-summaries-list">
                {% for summary in summaries %}
                <div class="summary-item{{ ' bookmarked' if summary.is_bookmarked else '' }}" data-filename="{{ summary.filename }}" data-channel="{{ summary.channel }}" data-bookmarked="{{ summary.is_bookmarked|lower }}">
                    <input type="checkbox" class="form-check-input summary-checkbox" data-filename="{{ summary.filename }}">
                    <div class="summary-content" onclick="window.location.href='/summary/{{ summary.filename }}'">
                        <h6 class="mb-1">{{ summary.title }}</h6>
                        <div class="summary-meta">
                            <span class="badge-channel">ğŸ“º {{ summary.channel_display }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- ç„¡çµæœæç¤º -->
    <div class="empty-state" id="mobile-no-results" style="display: none;">
        <i class="bi bi-search"></i>
        <h3>æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„æ‘˜è¦</h3>
        <p>è«‹å˜—è©¦èª¿æ•´æœå°‹æ¢ä»¶æˆ–é »é“éæ¿¾å™¨</p>
    </div>
</div>

<!-- æ‡¸æµ®åŠŸèƒ½æŒ‰éˆ•çµ„ (Mobile Only) -->
<div class="floating-actions">
    <div class="fab-menu" id="fab-menu">
        <button class="fab fab-main" id="fab-main" title="æ›´å¤šåŠŸèƒ½">
            <i class="bi bi-three-dots"></i>
        </button>
        <div class="fab-actions">
            <button class="fab fab-action" id="toggle-search" title="æœå°‹æ‘˜è¦">
                <i class="bi bi-search"></i>
            </button>
            <button class="fab fab-action" id="toggle-batch" title="æ‰¹é‡æ“ä½œ">
                <i class="bi bi-check2-square"></i>
            </button>
        </div>
    </div>
</div>

<!-- æ‰‹æ©Ÿç‰ˆæ‰¹é‡æ“ä½œå·¥å…·åˆ— -->
<div class="mobile-batch-toolbar" id="mobile-batch-toolbar">
    <div class="d-flex justify-content-between align-items-center">
        <span id="mobile-selected-count">å·²é¸æ“‡ 0 å€‹é …ç›®</span>
        <div class="btn-group">
            <button class="btn btn-sm btn-outline-primary" id="mobile-batch-bookmark">
                <i class="bi bi-bookmark-plus"></i>
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="mobile-cancel-selection">
                <i class="bi bi-x"></i>
            </button>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
    // OpenCC converter instance
    let converter = null;

    // Initialize OpenCC converter for Traditional Chinese
    function initializeOpenCC() {
        try {
            converter = OpenCC.Converter({ from: 'cn', to: 'tw' });
            return true;
        } catch (error) {
            console.error('Failed to initialize OpenCC:', error);
            return false;
        }
    }

    // Convert text to Traditional Chinese
    function convertToTraditional(text) {
        if (!converter || !text) return text;
        try {
            return converter(text);
        } catch (error) {
            console.error('Failed to convert text:', error);
            return text;
        }
    }

    // Convert all summary titles to Traditional Chinese
    function convertSummaryTitles() {
        if (!converter) return;

        const isMobile = window.innerWidth <= 768;
        const viewClass = isMobile ? '.mobile-view' : '.desktop-view';

        document.querySelectorAll(`${viewClass} .summary-item:not([style*="display: none"]) .summary-content h6`).forEach(titleElement => {
            if (titleElement.getAttribute('data-converted') === 'true') return;

            const originalText = titleElement.textContent;
            const convertedText = convertToTraditional(originalText);
            if (convertedText !== originalText) {
                titleElement.textContent = convertedText;
                titleElement.setAttribute('data-converted', 'true');
            }
        });

        document.querySelectorAll(`${viewClass} .summary-item:not([style*="display: none"]) .badge-channel`).forEach(badgeElement => {
            if (badgeElement.getAttribute('data-converted') === 'true') return;

            const originalText = badgeElement.textContent.replace('ğŸ“º ', '');
            const convertedText = convertToTraditional(originalText);
            if (convertedText !== originalText) {
                badgeElement.textContent = (badgeElement.textContent.includes('ğŸ“º') ? 'ğŸ“º ' : '') + convertedText;
                badgeElement.setAttribute('data-converted', 'true');
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize OpenCC and convert titles
        if (initializeOpenCC()) {
            convertSummaryTitles();
        }

        // Re-convert titles when window is resized (mobile/desktop switch)
        window.addEventListener('resize', function() {
            document.querySelectorAll('[data-converted]').forEach(element => {
                element.removeAttribute('data-converted');
            });
            setTimeout(() => {
                convertSummaryTitles();
            }, 100);
        });

        const isMobile = window.innerWidth <= 768;
        const prefix = isMobile ? 'mobile' : 'desktop';

        // Get elements with proper prefix
        const searchInput = document.getElementById(prefix + '-search-input');
        const channelFilter = document.getElementById(prefix + '-channel-filter');
        const summariesList = document.getElementById(prefix + '-summaries-list');
        const noResults = document.getElementById(prefix + '-no-results');
        const filterStatus = document.getElementById(prefix + '-filter-status');
        const clearSearchBtn = document.getElementById(prefix + '-clear-search');
        const clearFiltersBtn = document.getElementById(prefix + '-clear-filters');

        // Mobile-specific elements
        if (isMobile) {
            const hiddenSearch = document.getElementById('mobile-hidden-search');
            const fabMenu = document.getElementById('fab-menu');
            const fabMain = document.getElementById('fab-main');
            const toggleSearch = document.getElementById('toggle-search');
            const toggleBatch = document.getElementById('toggle-batch');

            let isMenuOpen = false;

            // FAB functionality
            fabMain.addEventListener('click', function() {
                isMenuOpen = !isMenuOpen;
                fabMenu.classList.toggle('active', isMenuOpen);

                if (!isMenuOpen) {
                    hiddenSearch.style.display = 'none';
                }
            });

            toggleSearch.addEventListener('click', function() {
                const isVisible = hiddenSearch.style.display !== 'none';
                hiddenSearch.style.display = isVisible ? 'none' : 'block';
                closeFabMenu();
            });

            toggleBatch.addEventListener('click', function() {
                enableBatchMode();
                closeFabMenu();
            });

            function closeFabMenu() {
                isMenuOpen = false;
                fabMenu.classList.remove('active');
            }

            function enableBatchMode() {
                document.body.classList.add('batch-mode');
                document.querySelectorAll('.mobile-view .summary-checkbox').forEach(checkbox => {
                    checkbox.style.display = 'block';
                });
            }
        }

        // Filter functionality
        function filterSummaries() {
            if (!searchInput) return;

            const searchTerm = searchInput.value.toLowerCase();
            const selectedChannel = channelFilter ? channelFilter.value : '';
            let visibleCount = 0;

            const summaryItems = document.querySelectorAll((isMobile ? '.mobile-view' : '.desktop-view') + ' .summary-item');

            summaryItems.forEach(item => {
                const title = item.dataset.title ? item.dataset.title.toLowerCase() : item.dataset.filename.toLowerCase();
                const channel = item.dataset.channel;

                const matchesSearch = !searchTerm || title.includes(searchTerm);
                const matchesChannel = !selectedChannel || channel.trim() === selectedChannel.trim();

                if (matchesSearch && matchesChannel) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            // Update status
            if (filterStatus) {
                let statusText = `é¡¯ç¤º ${visibleCount} å€‹æ‘˜è¦`;
                if (searchTerm || selectedChannel) {
                    statusText += ' (å·²éæ¿¾)';
                }
                filterStatus.textContent = statusText;
            }

            // Show/hide no results
            if (noResults) {
                if (visibleCount === 0) {
                    summariesList.style.display = 'none';
                    noResults.style.display = 'block';
                } else {
                    summariesList.style.display = 'block';
                    noResults.style.display = 'none';
                    convertSummaryTitles();
                }
            }
        }

        // é »é“æ¨™ç±¤é»æ“Šäº‹ä»¶
        document.querySelectorAll('.channel-chip').forEach(chip => {
            chip.addEventListener('click', function() {
                const channel = this.dataset.channel;

                // æ›´æ–°æ¨™ç±¤ç‹€æ…‹
                document.querySelectorAll('.channel-chip').forEach(c => c.classList.remove('active'));
                this.classList.add('active');

                // åŒæ­¥æ›´æ–°ä¸‹æ‹‰é¸å–® (å¦‚æœå­˜åœ¨)
                if (channelFilter) {
                    channelFilter.value = channel;
                }

                // åŸ·è¡Œç¯©é¸
                let visibleCount = 0;
                const summaryItems = document.querySelectorAll((isMobile ? '.mobile-view' : '.desktop-view') + ' .summary-item');
                const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

                summaryItems.forEach(item => {
                    const title = item.dataset.title ? item.dataset.title.toLowerCase() : item.dataset.filename.toLowerCase();
                    const itemChannel = item.dataset.channel;

                    const matchesSearch = !searchTerm || title.includes(searchTerm);
                    const matchesChannel = !channel || itemChannel.trim() === channel.trim();

                    if (matchesSearch && matchesChannel) {
                        item.style.display = '';
                        visibleCount++;
                    } else {
                        item.style.display = 'none';
                    }
                });

                // æ›´æ–°ç‹€æ…‹æ–‡å­—
                if (filterStatus) {
                    let statusText = `é¡¯ç¤º ${visibleCount} å€‹æ‘˜è¦`;
                    if (searchTerm || channel) {
                        statusText += ' (å·²éæ¿¾)';
                    }
                    filterStatus.textContent = statusText;
                }

                // é¡¯ç¤º/éš±è—ç„¡çµæœæç¤º
                if (noResults) {
                    if (visibleCount === 0) {
                        summariesList.style.display = 'none';
                        noResults.style.display = 'block';
                    } else {
                        summariesList.style.display = 'block';
                        noResults.style.display = 'none';
                        convertSummaryTitles();
                    }
                }
            });
        });

        // Event listeners for filtering
        if (searchInput) searchInput.addEventListener('input', filterSummaries);
        if (channelFilter) {
            channelFilter.addEventListener('change', function() {
                const selectedChannel = this.value;
                document.querySelectorAll('.channel-chip').forEach(chip => {
                    if (chip.dataset.channel === selectedChannel) {
                        chip.classList.add('active');
                    } else {
                        chip.classList.remove('active');
                    }
                });
                filterSummaries();
            });
        }
        if (clearSearchBtn) {
            clearSearchBtn.addEventListener('click', function() {
                if (searchInput) {
                    searchInput.value = '';
                    filterSummaries();
                }
            });
        }
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', function() {
                if (searchInput) searchInput.value = '';
                if (channelFilter) channelFilter.value = '';
                document.querySelectorAll('.channel-chip').forEach(chip => {
                    chip.classList.remove('active');
                    if (chip.dataset.channel === '') {
                        chip.classList.add('active');
                    }
                });
                filterSummaries();
            });
        }

        // Batch selection functionality
        const checkboxes = document.querySelectorAll('.summary-checkbox');
        const batchToolbar = document.getElementById(prefix + '-batch-toolbar');
        const selectedCount = document.getElementById(prefix + '-selected-count');
        const cancelSelection = document.getElementById(prefix + '-cancel-selection');
        const batchBookmark = document.getElementById(prefix + '-batch-bookmark');
        const batchDelete = document.getElementById(prefix + '-batch-delete');

        function updateBatchToolbar() {
            const checkedBoxes = document.querySelectorAll('.summary-checkbox:checked');
            const count = checkedBoxes.length;

            if (batchToolbar && selectedCount) {
                if (count > 0) {
                    batchToolbar.style.display = 'block';
                    selectedCount.textContent = `å·²é¸æ“‡ ${count} å€‹é …ç›®`;
                    if (isMobile) {
                        document.body.classList.add('batch-mode');
                    }
                } else {
                    batchToolbar.style.display = 'none';
                    if (isMobile) {
                        document.body.classList.remove('batch-mode');
                        document.querySelectorAll('.mobile-view .summary-checkbox').forEach(checkbox => {
                            checkbox.style.display = 'none';
                            checkbox.checked = false;
                        });
                    }
                }
            }
        }

        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateBatchToolbar);
        });

        if (cancelSelection) {
            cancelSelection.addEventListener('click', function() {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                updateBatchToolbar();
            });
        }

        // Bookmark functionality
        document.querySelectorAll('.bookmark-toggle').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                const filename = this.dataset.filename;
                const icon = this.querySelector('i');
                const isBookmarked = icon.classList.contains('bi-bookmark-fill');

                fetch('/api/bookmark', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filename: filename,
                        action: isBookmarked ? 'remove' : 'add'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (isBookmarked) {
                            icon.classList.replace('bi-bookmark-fill', 'bi-bookmark');
                        } else {
                            icon.classList.replace('bi-bookmark', 'bi-bookmark-fill');
                        }
                    }
                })
                .catch(error => {
                    console.error('æ›¸ç±¤æ“ä½œå¤±æ•—:', error);
                });
            });
        });

        // Batch bookmark functionality
        if (batchBookmark) {
            batchBookmark.addEventListener('click', function() {
                const checkedBoxes = document.querySelectorAll('.summary-checkbox:checked');
                const filenames = Array.from(checkedBoxes).map(cb => cb.dataset.filename);

                if (filenames.length === 0) return;

                fetch('/api/batch-bookmark', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filenames: filenames,
                        action: 'add'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('æ‰¹é‡æ›¸ç±¤æ“ä½œå¤±æ•—ï¼š' + data.message);
                    }
                })
                .catch(error => {
                    console.error('æ‰¹é‡æ›¸ç±¤æ“ä½œå¤±æ•—:', error);
                    alert('æ‰¹é‡æ›¸ç±¤æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                });
            });
        }

        // Batch delete functionality
        if (batchDelete) {
            batchDelete.addEventListener('click', function() {
                const checkedBoxes = document.querySelectorAll('.summary-checkbox:checked');
                const filenames = Array.from(checkedBoxes).map(cb => cb.dataset.filename);

                if (filenames.length === 0) return;

                const confirmMessage = `ç¢ºå®šè¦åˆªé™¤é¸ä¸­çš„ ${filenames.length} å€‹æ‘˜è¦æª”æ¡ˆå—ï¼Ÿ\n\næª”æ¡ˆå°‡è¢«ç§»å‹•åˆ°å›æ”¶æ¡¶ï¼Œå¯ä»¥ç¨å¾Œé‚„åŸã€‚`;
                if (!confirm(confirmMessage)) return;

                const originalText = batchDelete.innerHTML;
                batchDelete.innerHTML = '<i class="bi bi-hourglass-split"></i> è™•ç†ä¸­...';
                batchDelete.disabled = true;

                fetch('/api/batch-delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filenames: filenames
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('æ‰¹é‡åˆªé™¤æ“ä½œå¤±æ•—ï¼š' + data.message);
                    }
                })
                .catch(error => {
                    console.error('æ‰¹é‡åˆªé™¤æ“ä½œå¤±æ•—:', error);
                    alert('æ‰¹é‡åˆªé™¤æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                })
                .finally(() => {
                    batchDelete.innerHTML = originalText;
                    batchDelete.disabled = false;
                });
            });
        }
    });
</script>
{% endblock %}
