{% extends "base.html" %}

{% block title %}æ‰€æœ‰æ‘˜è¦ç´€éŒ„ - Whisper Web App{% endblock %}

{% block head %}
<!-- OpenCC.js for Traditional Chinese conversion -->
<script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js"></script>
<!-- é˜²æ­¢è¦–åœ–åˆ‡æ›é–ƒçˆï¼šæ ¹æ“š localStorage é å…ˆéš±è—ä¸éœ€è¦çš„è¦–åœ– -->
<script>
    (function() {
        var savedView = localStorage.getItem('summaryView') || 'list';
        var style = document.createElement('style');
        style.id = 'view-preload-style';
        if (savedView === 'card') {
            style.textContent = '#list-view { display: none !important; } #card-view { display: block !important; }';
        } else {
            style.textContent = '#list-view { display: block !important; } #card-view { display: none !important; }';
        }
        document.head.appendChild(style);
    })();
</script>
<style>
    /* Desktop Styles */
    .desktop-view .summary-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--border-color);
    }
    .desktop-view .summary-item:last-child {
        border-bottom: none;
    }
    .desktop-view .summary-item:hover {
        background-color: var(--bg-secondary);
    }
    .desktop-view .summary-checkbox {
        margin-right: 1rem;
    }
    .desktop-view .summary-content {
        flex: 1;
        cursor: pointer;
    }
    .desktop-view .summary-content:hover {
        color: #0d6efd;
    }
    .desktop-view .batch-toolbar {
        background-color: var(--bg-secondary);
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--border-color);
        display: none;
    }
    .desktop-view .summary-meta {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }
    .desktop-view .summary-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    .desktop-view .btn-group .btn {
        white-space: nowrap;
    }
    .desktop-view .filter-section {
        background-color: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    /* è¦–åœ–åˆ‡æ›æŒ‰éˆ• */
    .btn-group .btn.active {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }

    /* å¡ç‰‡è¦–åœ–æ¨£å¼ */
    .summary-card .card {
        transition: all 0.3s ease;
        border: 1px solid var(--border-color);
        background-color: var(--bg-card);
    }
    .summary-card .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    [data-theme="dark"] .summary-card .card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .summary-card .card-header {
        background-color: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
        padding: 0.5rem 1rem;
    }
    .summary-card .card-body {
        padding: 1rem;
    }
    .summary-card .card-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: var(--text-primary);
        min-height: 2.4em;
        line-height: 1.2;
    }
    .summary-card .card-text {
        font-size: 0.875rem;
        line-height: 1.5;
        min-height: 4.5em;
    }

    /* æ–‡å­—æˆªæ–·æ¨£å¼ */
    .text-truncate-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .text-truncate-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .summary-card .card-footer {
        background-color: var(--bg-secondary);
        border-top: 1px solid var(--border-color);
        padding: 0.75rem 1rem;
    }

    /* å¯é»æ“Šçš„é »é“æ¨™ç±¤æ¨£å¼ */
    .badge-channel-clickable {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .badge-channel-clickable:hover {
        background-color: #0d6efd !important;
        color: white !important;
        transform: scale(1.05);
    }

    /* å¿«é€Ÿé »é“éæ¿¾æ¨™ç±¤æ¨£å¼ */
    .channel-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    .channel-chip {
        border: 2px solid var(--border-color);
        background-color: var(--bg-card);
        padding: 0.5rem 1rem;
        border-radius: 1.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        color: var(--text-primary);
    }
    .channel-chip:hover {
        border-color: #0d6efd;
        background-color: var(--bg-secondary);
        transform: translateY(-2px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .channel-chip.active {
        border-color: #0d6efd;
        background-color: #0d6efd;
        color: white;
    }
    .channel-chip .badge {
        font-size: 0.75rem;
    }
    .channel-chip.active .badge {
        background-color: rgba(255,255,255,0.3) !important;
    }

    /* å·¦å´å¯æ”¶åˆé »é“é¢æ¿æ¨£å¼ */
    .channel-sidebar {
        position: fixed;
        top: 0;
        left: -320px;
        width: 320px;
        height: 100vh;
        background-color: var(--bg-card);
        border-right: 1px solid var(--border-color);
        z-index: 1050;
        transition: left 0.3s ease;
        display: flex;
        flex-direction: column;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    .channel-sidebar.open {
        left: 0;
    }
    .channel-sidebar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        background-color: var(--bg-secondary);
    }
    .channel-sidebar-header h5 {
        margin: 0;
        font-weight: 600;
    }
    .channel-sidebar-body {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
    }
    .channel-sidebar-search {
        padding: 0.75rem;
        border-bottom: 1px solid var(--border-color);
    }
    .channel-sidebar-search input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        background-color: var(--bg-card);
        color: var(--text-primary);
    }
    .channel-sidebar-search input:focus {
        outline: none;
        border-color: #0d6efd;
    }
    .sidebar-channel-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        margin: 0.25rem 0;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        color: var(--text-primary);
        border: 2px solid transparent;
    }
    .sidebar-channel-item:hover {
        background-color: var(--bg-secondary);
    }
    .sidebar-channel-item.active {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }
    .sidebar-channel-item .channel-name {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin-right: 0.5rem;
    }
    .sidebar-channel-item .channel-count {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 1rem;
        background-color: var(--bg-secondary);
    }
    .sidebar-channel-item.active .channel-count {
        background-color: rgba(255,255,255,0.2);
    }
    .channel-sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0,0,0,0.5);
        z-index: 1040;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }
    .channel-sidebar-overlay.show {
        opacity: 1;
        visibility: visible;
    }
    .sidebar-toggle-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: 0.5rem;
        background-color: var(--bg-card);
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 500;
    }
    .sidebar-toggle-btn:hover {
        border-color: #0d6efd;
        background-color: var(--bg-secondary);
    }
    .sidebar-toggle-btn i {
        font-size: 1.1rem;
    }
    .current-channel-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.75rem;
        background-color: #0d6efd;
        color: white;
        border-radius: 1rem;
        font-size: 0.875rem;
        margin-left: 0.5rem;
    }
    .current-channel-badge .clear-filter {
        cursor: pointer;
        margin-left: 0.25rem;
        opacity: 0.8;
    }
    .current-channel-badge .clear-filter:hover {
        opacity: 1;
    }

    /* Mobile Styles */
    .mobile-view {
        display: none;
    }

    .mobile-view .simple-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 1rem;
    }

    .mobile-view .summary-count {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .mobile-view .hidden-nav,
    .mobile-view .hidden-search {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        animation: slideDown 0.3s ease;
        display: none;
    }

    .mobile-view .nav-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .mobile-view .summary-item {
        margin-bottom: 0.75rem;
        padding: 0;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        background: var(--bg-card);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        position: relative;
    }

    .mobile-view .summary-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .mobile-view .summary-checkbox {
        position: absolute;
        top: 1rem;
        left: 1rem;
        transform: scale(1.3);
        z-index: 10;
        display: none;
    }

    .mobile-view .summary-content {
        padding: 1rem;
        cursor: pointer;
    }

    .mobile-view .summary-content h6 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        line-height: 1.4;
        color: var(--text-primary);
    }

    .mobile-view .summary-meta {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .mobile-view .summary-item.bookmarked {
        border-color: #ffc107;
        border-width: 2px;
    }

    .mobile-view .summary-item.bookmarked::before {
        content: "\f4a5";
        font-family: "Bootstrap Icons";
        position: absolute;
        top: 1rem;
        right: 1rem;
        color: #ffc107;
        font-size: 1.2rem;
        z-index: 5;
    }

    /* Floating Action Button */
    .floating-actions {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        display: none;
    }

    .fab {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        border: none;
        background: #007bff;
        color: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .fab:hover {
        background: #0056b3;
        transform: scale(1.1);
    }

    .fab-menu.active .fab-main {
        background: #dc3545;
        transform: rotate(45deg);
    }

    .fab-actions {
        position: absolute;
        bottom: 0;
        right: 0;
        display: flex;
        flex-direction: column-reverse;
        gap: 12px;
        opacity: 0;
        pointer-events: none;
        transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .fab-menu.active .fab-actions {
        opacity: 1;
        pointer-events: auto;
        transform: translateY(-68px);
    }

    .fab-action {
        width: 48px;
        height: 48px;
        font-size: 1rem;
        background: #6c757d;
        transform: scale(0);
        animation: fabScale 0.3s ease forwards;
    }

    .fab-action:nth-child(1) { animation-delay: 0.1s; }
    .fab-action:nth-child(2) { animation-delay: 0.2s; }
    .fab-action:nth-child(3) { animation-delay: 0.3s; }

    @keyframes fabScale {
        to {
            transform: scale(1);
        }
    }

    /* Mobile batch toolbar */
    .mobile-batch-toolbar {
        position: fixed;
        bottom: 20px;
        left: 20px;
        right: 20px;
        z-index: 1000;
        border-radius: 25px;
        padding: 1rem 1.5rem;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        display: none;
    }

    [data-theme="dark"] .mobile-batch-toolbar {
        background: rgba(22, 27, 34, 0.95);
    }

    /* Media Queries */
    @media (max-width: 768px) {
        .desktop-view {
            display: none !important;
        }
        .mobile-view {
            display: block !important;
        }
        .floating-actions {
            display: block;
        }
        body.batch-mode .mobile-view .summary-checkbox {
            display: block;
        }
        body.batch-mode {
            padding-bottom: 100px;
        }
    }

    @media (min-width: 769px) {
        .mobile-view {
            display: none !important;
        }
        .desktop-view {
            display: block !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- å·¦å´é »é“ç¯©é¸é¢æ¿ -->
<div class="channel-sidebar-overlay" id="channel-sidebar-overlay"></div>
<div class="channel-sidebar" id="channel-sidebar">
    <div class="channel-sidebar-header">
        <h5><i class="bi bi-funnel"></i> é »é“ç¯©é¸</h5>
        <button class="btn btn-sm btn-outline-secondary" id="close-sidebar-btn">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>
    <div class="channel-sidebar-search">
        <input type="text" id="sidebar-channel-search" placeholder="æœå°‹é »é“åç¨±...">
    </div>
    <div class="channel-sidebar-body">
        <div class="sidebar-channel-item active" data-channel="">
            <span class="channel-name">ğŸ“º å…¨éƒ¨é »é“</span>
            <span class="channel-count">{{ summaries|length }}</span>
        </div>
        {% for channel in channels %}
        <div class="sidebar-channel-item" data-channel="{{ channel_original_names.get(channel, channel) }}">
            <span class="channel-name">{{ channel }}</span>
            <span class="channel-count">{{ channel_counts[channel] }}</span>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Page Header -->
<div class="page-header">
    <h1>æ‰€æœ‰æ‘˜è¦ç´€éŒ„</h1>
    <p class="page-description">å…± {{ summaries|length }} å€‹æ‘˜è¦</p>
</div>

<!-- Desktop View -->
<div class="desktop-view">
    <!-- æ‰¹é‡å·¥å…·åˆ— -->
    <div class="batch-toolbar" id="desktop-batch-toolbar">
        <div class="d-flex justify-content-between align-items-center">
            <span id="desktop-selected-count">å·²é¸æ“‡ 0 å€‹é …ç›®</span>
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" id="desktop-batch-bookmark">
                    <i class="bi bi-bookmark-plus"></i> æ‰¹é‡æ›¸ç±¤
                </button>
                <button class="btn btn-sm btn-outline-danger" id="desktop-batch-delete">
                    <i class="bi bi-trash"></i> æ‰¹é‡åˆªé™¤
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="desktop-cancel-selection">
                    <i class="bi bi-x"></i> å–æ¶ˆé¸æ“‡
                </button>
            </div>
        </div>
    </div>

    <!-- éæ¿¾å™¨å€åŸŸ -->
    <div class="filter-section">
        <!-- é »é“ç¯©é¸æŒ‰éˆ•èˆ‡è¦–åœ–åˆ‡æ› -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <button class="sidebar-toggle-btn" id="open-sidebar-btn">
                    <i class="bi bi-funnel"></i> é »é“ç¯©é¸
                </button>
                <span class="current-channel-badge" id="current-channel-badge" style="display: none;">
                    <span id="current-channel-name"></span>
                    <i class="bi bi-x-circle-fill clear-filter" id="clear-channel-filter"></i>
                </span>
            </div>
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-secondary active" id="list-view-btn" title="åˆ—è¡¨è¦–åœ–">
                    <i class="bi bi-list-ul"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" id="card-view-btn" title="å¡ç‰‡è¦–åœ–">
                    <i class="bi bi-grid-3x3-gap"></i>
                </button>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-md-9">
                <label for="desktop-search-input" class="form-label">æœå°‹</label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" class="form-control" id="desktop-search-input" placeholder="æœå°‹æ‘˜è¦æ¨™é¡Œ...">
                    <button class="btn btn-outline-secondary" type="button" id="desktop-clear-search">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button class="btn btn-outline-secondary w-100" type="button" id="desktop-clear-filters">
                        <i class="bi bi-arrow-clockwise"></i> é‡ç½®ç¯©é¸
                    </button>
                </div>
            </div>
        </div>
        <div class="mt-2">
            <small class="text-muted" id="desktop-filter-status">é¡¯ç¤ºå…¨éƒ¨ {{ summaries|length }} å€‹æ‘˜è¦</small>
        </div>
    </div>

    <!-- éš±è—çš„é »é“ä¸‹æ‹‰é¸å–®ï¼ˆä¿ç•™çµ¦ JS ä½¿ç”¨ï¼‰ -->
    <select class="form-select d-none" id="desktop-channel-filter">
        <option value="">å…¨éƒ¨é »é“ ({{ summaries|length }})</option>
        {% for channel in channels %}
        <option value="{{ channel_original_names.get(channel, channel) }}">{{ channel }} ({{ channel_counts[channel] }})</option>
        {% endfor %}
    </select>

    <!-- åˆ—è¡¨è¦–åœ– -->
    <div id="list-view" class="card">
        <div class="card-body p-0">
            <div class="list-group list-group-flush" id="desktop-summaries-list">
                {% for summary in summaries %}
                <div class="summary-item" data-filename="{{ summary.filename }}" data-title="{{ summary.title }}" data-channel="{{ summary.channel }}" data-bookmarked="{{ summary.is_bookmarked|lower }}">
                    <input type="checkbox" class="form-check-input summary-checkbox" data-filename="{{ summary.filename }}">
                    <div class="summary-content" onclick="window.location.href='/summary/{{ summary.filename }}'">
                        <h6 class="mb-1">{{ summary.title }}</h6>
                        <div class="summary-meta">
                            <span class="badge-channel">{{ summary.channel_display }}</span>
                            {% if summary.is_bookmarked %}
                            <span class="badge-bookmark">
                                <i class="bi bi-bookmark-fill"></i> å·²æ›¸ç±¤
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="summary-actions">
                        <button class="btn btn-sm btn-outline-primary bookmark-toggle" data-filename="{{ summary.filename }}">
                            <i class="bi bi-bookmark{{ '-fill' if summary.is_bookmarked else '' }}"></i>
                        </button>
                        <a href="/download/summary/{{ summary.filename }}" class="btn btn-sm btn-outline-success">
                            <i class="bi bi-download"></i>
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- å¡ç‰‡è¦–åœ– -->
    <div id="card-view" style="display: none;">
        <div class="row g-3" id="desktop-summaries-cards">
            {% for summary in summaries %}
            <div class="col-12 col-md-6 col-lg-4">
                <div class="summary-card" data-filename="{{ summary.filename }}" data-title="{{ summary.title }}" data-channel="{{ summary.channel }}" data-bookmarked="{{ summary.is_bookmarked|lower }}">
                    <div class="card h-100">
                        <div class="card-header d-flex align-items-center gap-2">
                            <input type="checkbox" class="form-check-input summary-checkbox m-0" data-filename="{{ summary.filename }}">
                            <span class="badge-channel badge-channel-clickable small text-truncate" style="max-width: 150px;" data-channel="{{ summary.channel }}" data-channel-display="{{ summary.channel_display }}" title="é»æ“Šç¯©é¸æ­¤é »é“">{{ summary.channel_display }}</span>
                            <div class="ms-auto d-flex align-items-center gap-1">
                                <a href="/download/summary/{{ summary.filename }}" class="btn btn-sm btn-outline-success p-1" onclick="event.stopPropagation()" title="ä¸‹è¼‰">
                                    <i class="bi bi-download"></i>
                                </a>
                                <button class="btn btn-sm btn-link bookmark-toggle p-0" data-filename="{{ summary.filename }}" title="æ›¸ç±¤">
                                    <i class="bi bi-bookmark{{ '-fill' if summary.is_bookmarked else '' }} fs-5 {{ 'text-warning' if summary.is_bookmarked else 'text-secondary' }}"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body" style="cursor: pointer;" onclick="window.location.href='/summary/{{ summary.filename }}'">
                            <h6 class="card-title text-truncate-2">{{ summary.title }}</h6>
                            {% if summary.preview %}
                            <p class="card-text text-muted small text-truncate-3" style="white-space: pre-line;">{{ summary.preview }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ç„¡çµæœæç¤º -->
    <div class="empty-state" id="desktop-no-results" style="display: none;">
        <i class="bi bi-search"></i>
        <h3>æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„æ‘˜è¦</h3>
        <p>è«‹å˜—è©¦èª¿æ•´æœå°‹æ¢ä»¶æˆ–é »é“éæ¿¾å™¨</p>
    </div>
</div>

<!-- Mobile View -->
<div class="mobile-view">
    <div class="simple-header mb-3">
        <h1 class="h4 mb-0">æ‘˜è¦åˆ—è¡¨</h1>
        <span class="summary-count">å…± {{ summaries|length }} å€‹æ‘˜è¦</span>
    </div>

    <!-- é »é“ç¯©é¸æŒ‰éˆ• (æ‰‹æ©Ÿç‰ˆ) -->
    <div class="mb-3">
        <button class="sidebar-toggle-btn w-100" id="mobile-open-sidebar-btn">
            <i class="bi bi-funnel"></i> é »é“ç¯©é¸
            <span class="current-channel-badge ms-auto" id="mobile-current-channel-badge" style="display: none;">
                <span id="mobile-current-channel-name"></span>
            </span>
        </button>
    </div>

    <!-- éš±è—çš„æœå°‹å€åŸŸ -->
    <div class="hidden-search" id="mobile-hidden-search">
        <div class="input-group">
            <span class="input-group-text">
                <i class="bi bi-search"></i>
            </span>
            <input type="text" class="form-control" id="mobile-search-input" placeholder="æœå°‹æ‘˜è¦æ¨™é¡Œ...">
            <button class="btn btn-outline-secondary" type="button" id="mobile-clear-search">
                <i class="bi bi-x-lg"></i>
            </button>
            <button class="btn btn-outline-secondary" type="button" id="mobile-clear-filters">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
        <div class="mt-2">
            <small class="text-muted" id="mobile-filter-status">é¡¯ç¤ºå…¨éƒ¨ {{ summaries|length }} å€‹æ‘˜è¦</small>
        </div>
    </div>

    <!-- æ‘˜è¦åˆ—è¡¨ -->
    <div class="card">
        <div class="card-body p-0">
            <div class="list-group list-group-flush" id="mobile-summaries-list">
                {% for summary in summaries %}
                <div class="summary-item{{ ' bookmarked' if summary.is_bookmarked else '' }}" data-filename="{{ summary.filename }}" data-channel="{{ summary.channel }}" data-bookmarked="{{ summary.is_bookmarked|lower }}">
                    <input type="checkbox" class="form-check-input summary-checkbox" data-filename="{{ summary.filename }}">
                    <div class="summary-content" onclick="window.location.href='/summary/{{ summary.filename }}'">
                        <h6 class="mb-1">{{ summary.title }}</h6>
                        <div class="summary-meta">
                            <span class="badge-channel">ğŸ“º {{ summary.channel_display }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- ç„¡çµæœæç¤º -->
    <div class="empty-state" id="mobile-no-results" style="display: none;">
        <i class="bi bi-search"></i>
        <h3>æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„æ‘˜è¦</h3>
        <p>è«‹å˜—è©¦èª¿æ•´æœå°‹æ¢ä»¶æˆ–é »é“éæ¿¾å™¨</p>
    </div>
</div>

<!-- æ‡¸æµ®åŠŸèƒ½æŒ‰éˆ•çµ„ (Mobile Only) -->
<div class="floating-actions">
    <div class="fab-menu" id="fab-menu">
        <button class="fab fab-main" id="fab-main" title="æ›´å¤šåŠŸèƒ½">
            <i class="bi bi-three-dots"></i>
        </button>
        <div class="fab-actions">
            <button class="fab fab-action" id="toggle-search" title="æœå°‹æ‘˜è¦">
                <i class="bi bi-search"></i>
            </button>
            <button class="fab fab-action" id="toggle-batch" title="æ‰¹é‡æ“ä½œ">
                <i class="bi bi-check2-square"></i>
            </button>
        </div>
    </div>
</div>

<!-- æ‰‹æ©Ÿç‰ˆæ‰¹é‡æ“ä½œå·¥å…·åˆ— -->
<div class="mobile-batch-toolbar" id="mobile-batch-toolbar">
    <div class="d-flex justify-content-between align-items-center">
        <span id="mobile-selected-count">å·²é¸æ“‡ 0 å€‹é …ç›®</span>
        <div class="btn-group">
            <button class="btn btn-sm btn-outline-primary" id="mobile-batch-bookmark">
                <i class="bi bi-bookmark-plus"></i>
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="mobile-cancel-selection">
                <i class="bi bi-x"></i>
            </button>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
    // OpenCC converter instance
    let converter = null;

    // Initialize OpenCC converter for Traditional Chinese
    function initializeOpenCC() {
        try {
            converter = OpenCC.Converter({ from: 'cn', to: 'tw' });
            return true;
        } catch (error) {
            console.error('Failed to initialize OpenCC:', error);
            return false;
        }
    }

    // Convert text to Traditional Chinese
    function convertToTraditional(text) {
        if (!converter || !text) return text;
        try {
            return converter(text);
        } catch (error) {
            console.error('Failed to convert text:', error);
            return text;
        }
    }

    // Convert all summary titles to Traditional Chinese
    function convertSummaryTitles() {
        if (!converter) return;

        const isMobile = window.innerWidth <= 768;
        const viewClass = isMobile ? '.mobile-view' : '.desktop-view';

        document.querySelectorAll(`${viewClass} .summary-item:not([style*="display: none"]) .summary-content h6`).forEach(titleElement => {
            if (titleElement.getAttribute('data-converted') === 'true') return;

            const originalText = titleElement.textContent;
            const convertedText = convertToTraditional(originalText);
            if (convertedText !== originalText) {
                titleElement.textContent = convertedText;
                titleElement.setAttribute('data-converted', 'true');
            }
        });

        document.querySelectorAll(`${viewClass} .summary-item:not([style*="display: none"]) .badge-channel`).forEach(badgeElement => {
            if (badgeElement.getAttribute('data-converted') === 'true') return;

            const originalText = badgeElement.textContent.replace('ğŸ“º ', '');
            const convertedText = convertToTraditional(originalText);
            if (convertedText !== originalText) {
                badgeElement.textContent = (badgeElement.textContent.includes('ğŸ“º') ? 'ğŸ“º ' : '') + convertedText;
                badgeElement.setAttribute('data-converted', 'true');
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize OpenCC and convert titles
        if (initializeOpenCC()) {
            convertSummaryTitles();
        }

        // ========== å·¦å´é »é“ç¯©é¸é¢æ¿åŠŸèƒ½ ==========
        const channelSidebar = document.getElementById('channel-sidebar');
        const channelSidebarOverlay = document.getElementById('channel-sidebar-overlay');
        const openSidebarBtn = document.getElementById('open-sidebar-btn');
        const mobileOpenSidebarBtn = document.getElementById('mobile-open-sidebar-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const sidebarChannelSearch = document.getElementById('sidebar-channel-search');
        const currentChannelBadge = document.getElementById('current-channel-badge');
        const currentChannelName = document.getElementById('current-channel-name');
        const mobileCurrentChannelBadge = document.getElementById('mobile-current-channel-badge');
        const mobileCurrentChannelName = document.getElementById('mobile-current-channel-name');
        const clearChannelFilter = document.getElementById('clear-channel-filter');

        let currentSelectedChannel = '';

        function openSidebar() {
            channelSidebar.classList.add('open');
            channelSidebarOverlay.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeSidebar() {
            channelSidebar.classList.remove('open');
            channelSidebarOverlay.classList.remove('show');
            document.body.style.overflow = '';
        }

        function updateCurrentChannelBadge(channelName) {
            if (channelName) {
                currentSelectedChannel = channelName;
                if (currentChannelBadge) {
                    currentChannelBadge.style.display = 'inline-flex';
                    currentChannelName.textContent = channelName;
                }
                if (mobileCurrentChannelBadge) {
                    mobileCurrentChannelBadge.style.display = 'inline-flex';
                    mobileCurrentChannelName.textContent = channelName;
                }
            } else {
                currentSelectedChannel = '';
                if (currentChannelBadge) currentChannelBadge.style.display = 'none';
                if (mobileCurrentChannelBadge) mobileCurrentChannelBadge.style.display = 'none';
            }
        }

        // é–‹å•Ÿå´é‚Šæ¬„
        if (openSidebarBtn) openSidebarBtn.addEventListener('click', openSidebar);
        if (mobileOpenSidebarBtn) mobileOpenSidebarBtn.addEventListener('click', openSidebar);
        if (closeSidebarBtn) closeSidebarBtn.addEventListener('click', closeSidebar);
        if (channelSidebarOverlay) channelSidebarOverlay.addEventListener('click', closeSidebar);

        // æ¸…é™¤é »é“ç¯©é¸
        if (clearChannelFilter) {
            clearChannelFilter.addEventListener('click', function(e) {
                e.stopPropagation();
                selectSidebarChannel('', 'å…¨éƒ¨é »é“');
            });
        }

        // å´é‚Šæ¬„é »é“æœå°‹
        if (sidebarChannelSearch) {
            sidebarChannelSearch.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                document.querySelectorAll('.sidebar-channel-item').forEach(item => {
                    const channelName = item.querySelector('.channel-name').textContent.toLowerCase();
                    item.style.display = channelName.includes(searchTerm) ? '' : 'none';
                });
            });
        }

        // å´é‚Šæ¬„é »é“é¸æ“‡
        document.querySelectorAll('.sidebar-channel-item').forEach(item => {
            item.addEventListener('click', function() {
                const channel = this.dataset.channel;
                const channelName = this.querySelector('.channel-name').textContent.trim();
                selectSidebarChannel(channel, channelName);
                closeSidebar();
            });
        });

        function selectSidebarChannel(channel, displayName) {
            // æ›´æ–°å´é‚Šæ¬„é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.sidebar-channel-item').forEach(item => {
                item.classList.toggle('active', item.dataset.channel === channel);
            });

            // æ›´æ–°ç•¶å‰é »é“æ¨™ç±¤
            updateCurrentChannelBadge(channel ? displayName : '');

            // åŒæ­¥éš±è—çš„ä¸‹æ‹‰é¸å–®
            const channelFilter = document.getElementById('desktop-channel-filter');
            if (channelFilter) channelFilter.value = channel;

            // åŸ·è¡Œç¯©é¸
            filterByChannel(channel);
        }

        function filterByChannel(channel) {
            const isMobile = window.innerWidth <= 768;
            const prefix = isMobile ? 'mobile' : 'desktop';
            const searchInput = document.getElementById(prefix + '-search-input');
            const filterStatus = document.getElementById(prefix + '-filter-status');
            const noResults = document.getElementById(prefix + '-no-results');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

            let visibleCount = 0;
            const summaryItems = document.querySelectorAll((isMobile ? '.mobile-view' : '.desktop-view') + ' .summary-item');
            const summaryCards = document.querySelectorAll('.desktop-view .summary-card');

            // éæ¿¾åˆ—è¡¨è¦–åœ–
            summaryItems.forEach(item => {
                const title = item.dataset.title ? item.dataset.title.toLowerCase() : item.dataset.filename.toLowerCase();
                const itemChannel = item.dataset.channel;

                const matchesSearch = !searchTerm || title.includes(searchTerm);
                const matchesChannel = !channel || itemChannel.trim() === channel.trim();

                if (matchesSearch && matchesChannel) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            // éæ¿¾å¡ç‰‡è¦–åœ–
            let cardVisibleCount = 0;
            summaryCards.forEach(card => {
                const title = card.dataset.title ? card.dataset.title.toLowerCase() : card.dataset.filename.toLowerCase();
                const itemChannel = card.dataset.channel;

                const matchesSearch = !searchTerm || title.includes(searchTerm);
                const matchesChannel = !channel || itemChannel.trim() === channel.trim();

                const colElement = card.parentElement;
                if (matchesSearch && matchesChannel) {
                    colElement.style.display = '';
                    cardVisibleCount++;
                } else {
                    colElement.style.display = 'none';
                }
            });

            const currentView = localStorage.getItem('summaryView') || 'list';
            const finalVisibleCount = currentView === 'card' ? cardVisibleCount : visibleCount;

            if (filterStatus) {
                let statusText = `é¡¯ç¤º ${finalVisibleCount} å€‹æ‘˜è¦`;
                if (searchTerm || channel) statusText += ' (å·²éæ¿¾)';
                filterStatus.textContent = statusText;
            }

            if (noResults) {
                const listViewElement = document.getElementById('list-view');
                const cardViewElement = document.getElementById('card-view');

                if (finalVisibleCount === 0) {
                    if (listViewElement) listViewElement.style.display = 'none';
                    if (cardViewElement) cardViewElement.style.display = 'none';
                    noResults.style.display = 'block';
                } else {
                    if (currentView === 'card') {
                        if (listViewElement) listViewElement.style.display = 'none';
                        if (cardViewElement) cardViewElement.style.display = 'block';
                    } else {
                        if (listViewElement) listViewElement.style.display = 'block';
                        if (cardViewElement) cardViewElement.style.display = 'none';
                    }
                    noResults.style.display = 'none';
                    convertSummaryTitles();
                }
            }
        }

        // ========== è¦–åœ–åˆ‡æ›åŠŸèƒ½ ==========
        const listViewBtn = document.getElementById('list-view-btn');
        const cardViewBtn = document.getElementById('card-view-btn');
        const listView = document.getElementById('list-view');
        const cardView = document.getElementById('card-view');

        // è¼‰å…¥å„²å­˜çš„è¦–åœ–åå¥½
        const savedView = localStorage.getItem('summaryView') || 'list';
        if (savedView === 'card') {
            switchToCardView();
        }

        listViewBtn.addEventListener('click', function() {
            switchToListView();
        });

        cardViewBtn.addEventListener('click', function() {
            switchToCardView();
        });

        function switchToListView() {
            listView.style.display = 'block';
            cardView.style.display = 'none';
            listViewBtn.classList.add('active');
            cardViewBtn.classList.remove('active');
            localStorage.setItem('summaryView', 'list');
        }

        function switchToCardView() {
            listView.style.display = 'none';
            cardView.style.display = 'block';
            listViewBtn.classList.remove('active');
            cardViewBtn.classList.add('active');
            localStorage.setItem('summaryView', 'card');
        }

        // Re-convert titles when window is resized (mobile/desktop switch)
        window.addEventListener('resize', function() {
            document.querySelectorAll('[data-converted]').forEach(element => {
                element.removeAttribute('data-converted');
            });
            setTimeout(() => {
                convertSummaryTitles();
            }, 100);
        });

        const isMobile = window.innerWidth <= 768;
        const prefix = isMobile ? 'mobile' : 'desktop';

        // Get elements with proper prefix
        const searchInput = document.getElementById(prefix + '-search-input');
        const channelFilter = document.getElementById(prefix + '-channel-filter');
        const summariesList = document.getElementById(prefix + '-summaries-list');
        const noResults = document.getElementById(prefix + '-no-results');
        const filterStatus = document.getElementById(prefix + '-filter-status');
        const clearSearchBtn = document.getElementById(prefix + '-clear-search');
        const clearFiltersBtn = document.getElementById(prefix + '-clear-filters');

        // Mobile-specific elements
        if (isMobile) {
            const hiddenSearch = document.getElementById('mobile-hidden-search');
            const fabMenu = document.getElementById('fab-menu');
            const fabMain = document.getElementById('fab-main');
            const toggleSearch = document.getElementById('toggle-search');
            const toggleBatch = document.getElementById('toggle-batch');

            let isMenuOpen = false;

            // FAB functionality
            fabMain.addEventListener('click', function() {
                isMenuOpen = !isMenuOpen;
                fabMenu.classList.toggle('active', isMenuOpen);

                if (!isMenuOpen) {
                    hiddenSearch.style.display = 'none';
                }
            });

            toggleSearch.addEventListener('click', function() {
                const isVisible = hiddenSearch.style.display !== 'none';
                hiddenSearch.style.display = isVisible ? 'none' : 'block';
                closeFabMenu();
            });

            toggleBatch.addEventListener('click', function() {
                enableBatchMode();
                closeFabMenu();
            });

            function closeFabMenu() {
                isMenuOpen = false;
                fabMenu.classList.remove('active');
            }

            function enableBatchMode() {
                document.body.classList.add('batch-mode');
                document.querySelectorAll('.mobile-view .summary-checkbox').forEach(checkbox => {
                    checkbox.style.display = 'block';
                });
            }
        }

        // Filter functionality
        function filterSummaries() {
            if (!searchInput) return;

            const searchTerm = searchInput.value.toLowerCase();
            const selectedChannel = channelFilter ? channelFilter.value : '';
            let visibleCount = 0;

            // åŒæ™‚éæ¿¾åˆ—è¡¨è¦–åœ–å’Œå¡ç‰‡è¦–åœ–
            const summaryItems = document.querySelectorAll((isMobile ? '.mobile-view' : '.desktop-view') + ' .summary-item');
            const summaryCards = document.querySelectorAll('.desktop-view .summary-card');

            // éæ¿¾åˆ—è¡¨è¦–åœ–
            summaryItems.forEach(item => {
                const title = item.dataset.title ? item.dataset.title.toLowerCase() : item.dataset.filename.toLowerCase();
                const channel = item.dataset.channel;

                const matchesSearch = !searchTerm || title.includes(searchTerm);
                const matchesChannel = !selectedChannel || channel.trim() === selectedChannel.trim();

                if (matchesSearch && matchesChannel) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            // éæ¿¾å¡ç‰‡è¦–åœ–
            let cardVisibleCount = 0;
            summaryCards.forEach(card => {
                const title = card.dataset.title ? card.dataset.title.toLowerCase() : card.dataset.filename.toLowerCase();
                const channel = card.dataset.channel;

                const matchesSearch = !searchTerm || title.includes(searchTerm);
                const matchesChannel = !selectedChannel || channel.trim() === selectedChannel.trim();

                if (matchesSearch && matchesChannel) {
                    card.parentElement.style.display = '';
                    cardVisibleCount++;
                } else {
                    card.parentElement.style.display = 'none';
                }
            });

            // æ ¹æ“šç•¶å‰è¦–åœ–æ¨¡å¼é¸æ“‡æ­£ç¢ºçš„è¨ˆæ•¸
            const currentView = localStorage.getItem('summaryView') || 'list';
            const finalVisibleCount = currentView === 'card' ? cardVisibleCount : visibleCount;

            // Update status
            if (filterStatus) {
                let statusText = `é¡¯ç¤º ${finalVisibleCount} å€‹æ‘˜è¦`;
                if (searchTerm || selectedChannel) {
                    statusText += ' (å·²éæ¿¾)';
                }
                filterStatus.textContent = statusText;
            }

            // Show/hide no results
            if (noResults) {
                const listViewElement = document.getElementById('list-view');
                const cardViewElement = document.getElementById('card-view');

                if (finalVisibleCount === 0) {
                    if (listViewElement) listViewElement.style.display = 'none';
                    if (cardViewElement) cardViewElement.style.display = 'none';
                    noResults.style.display = 'block';
                } else {
                    if (currentView === 'card') {
                        if (listViewElement) listViewElement.style.display = 'none';
                        if (cardViewElement) cardViewElement.style.display = 'block';
                    } else {
                        if (listViewElement) listViewElement.style.display = 'block';
                        if (cardViewElement) cardViewElement.style.display = 'none';
                    }
                    noResults.style.display = 'none';
                    convertSummaryTitles();
                }
            }
        }

        // é »é“ç¯©é¸å·²ç§»è‡³å·¦å´é¢æ¿ï¼Œæ­¤è™•ä¿ç•™ç©ºç™½ä»¥ç¶­æŒç¨‹å¼ç¢¼çµæ§‹

        // Event listeners for filtering
        if (searchInput) searchInput.addEventListener('input', filterSummaries);
        if (channelFilter) {
            channelFilter.addEventListener('change', function() {
                const selectedChannel = this.value;
                document.querySelectorAll('.channel-chip').forEach(chip => {
                    if (chip.dataset.channel === selectedChannel) {
                        chip.classList.add('active');
                    } else {
                        chip.classList.remove('active');
                    }
                });
                filterSummaries();
            });
        }
        if (clearSearchBtn) {
            clearSearchBtn.addEventListener('click', function() {
                if (searchInput) {
                    searchInput.value = '';
                    filterSummaries();
                }
            });
        }
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', function() {
                if (searchInput) searchInput.value = '';
                if (channelFilter) channelFilter.value = '';
                // é‡ç½®å´é‚Šæ¬„é¸æ“‡
                document.querySelectorAll('.sidebar-channel-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.channel === '');
                });
                // æ¸…é™¤ç•¶å‰é »é“æ¨™ç±¤
                const currentChannelBadge = document.getElementById('current-channel-badge');
                const mobileCurrentChannelBadge = document.getElementById('mobile-current-channel-badge');
                if (currentChannelBadge) currentChannelBadge.style.display = 'none';
                if (mobileCurrentChannelBadge) mobileCurrentChannelBadge.style.display = 'none';
                filterSummaries();
            });
        }

        // Batch selection functionality
        const checkboxes = document.querySelectorAll('.summary-checkbox');
        const batchToolbar = document.getElementById(prefix + '-batch-toolbar');
        const selectedCount = document.getElementById(prefix + '-selected-count');
        const cancelSelection = document.getElementById(prefix + '-cancel-selection');
        const batchBookmark = document.getElementById(prefix + '-batch-bookmark');
        const batchDelete = document.getElementById(prefix + '-batch-delete');

        function updateBatchToolbar() {
            const checkedBoxes = document.querySelectorAll('.summary-checkbox:checked');
            const count = checkedBoxes.length;

            if (batchToolbar && selectedCount) {
                if (count > 0) {
                    batchToolbar.style.display = 'block';
                    selectedCount.textContent = `å·²é¸æ“‡ ${count} å€‹é …ç›®`;
                    if (isMobile) {
                        document.body.classList.add('batch-mode');
                    }
                } else {
                    batchToolbar.style.display = 'none';
                    if (isMobile) {
                        document.body.classList.remove('batch-mode');
                        document.querySelectorAll('.mobile-view .summary-checkbox').forEach(checkbox => {
                            checkbox.style.display = 'none';
                            checkbox.checked = false;
                        });
                    }
                }
            }
        }

        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateBatchToolbar);
        });

        if (cancelSelection) {
            cancelSelection.addEventListener('click', function() {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                updateBatchToolbar();
            });
        }

        // å¡ç‰‡é »é“æ¨™ç±¤é»æ“Šç¯©é¸åŠŸèƒ½
        document.querySelectorAll('.badge-channel-clickable').forEach(badge => {
            badge.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                const channel = this.dataset.channel;
                const channelDisplay = this.dataset.channelDisplay;

                // æ›´æ–°å´é‚Šæ¬„é¸ä¸­ç‹€æ…‹
                document.querySelectorAll('.sidebar-channel-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.channel === channel);
                });

                // æ›´æ–°ç•¶å‰é »é“æ¨™ç±¤
                const currentChannelBadge = document.getElementById('current-channel-badge');
                const currentChannelName = document.getElementById('current-channel-name');
                const mobileCurrentChannelBadge = document.getElementById('mobile-current-channel-badge');
                const mobileCurrentChannelName = document.getElementById('mobile-current-channel-name');

                if (currentChannelBadge) {
                    currentChannelBadge.style.display = 'inline-flex';
                    currentChannelName.textContent = channelDisplay;
                }
                if (mobileCurrentChannelBadge) {
                    mobileCurrentChannelBadge.style.display = 'inline-flex';
                    mobileCurrentChannelName.textContent = channelDisplay;
                }

                // åŒæ­¥éš±è—çš„ä¸‹æ‹‰é¸å–®
                const channelFilter = document.getElementById('desktop-channel-filter');
                if (channelFilter) channelFilter.value = channel;

                // åŸ·è¡Œç¯©é¸
                filterByChannel(channel);
            });
        });

        // Bookmark functionality
        document.querySelectorAll('.bookmark-toggle').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                const filename = this.dataset.filename;
                const icon = this.querySelector('i');
                const isBookmarked = icon.classList.contains('bi-bookmark-fill');

                fetch('/api/bookmark', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filename: filename,
                        action: isBookmarked ? 'remove' : 'add'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (isBookmarked) {
                            icon.classList.replace('bi-bookmark-fill', 'bi-bookmark');
                        } else {
                            icon.classList.replace('bi-bookmark', 'bi-bookmark-fill');
                        }
                    }
                })
                .catch(error => {
                    console.error('æ›¸ç±¤æ“ä½œå¤±æ•—:', error);
                });
            });
        });

        // Batch bookmark functionality
        if (batchBookmark) {
            batchBookmark.addEventListener('click', function() {
                const checkedBoxes = document.querySelectorAll('.summary-checkbox:checked');
                const filenames = Array.from(checkedBoxes).map(cb => cb.dataset.filename);

                if (filenames.length === 0) return;

                fetch('/api/batch-bookmark', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filenames: filenames,
                        action: 'add'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('æ‰¹é‡æ›¸ç±¤æ“ä½œå¤±æ•—ï¼š' + data.message);
                    }
                })
                .catch(error => {
                    console.error('æ‰¹é‡æ›¸ç±¤æ“ä½œå¤±æ•—:', error);
                    alert('æ‰¹é‡æ›¸ç±¤æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                });
            });
        }

        // Batch delete functionality
        if (batchDelete) {
            batchDelete.addEventListener('click', function() {
                const checkedBoxes = document.querySelectorAll('.summary-checkbox:checked');
                const filenames = Array.from(checkedBoxes).map(cb => cb.dataset.filename);

                if (filenames.length === 0) return;

                const confirmMessage = `ç¢ºå®šè¦åˆªé™¤é¸ä¸­çš„ ${filenames.length} å€‹æ‘˜è¦æª”æ¡ˆå—ï¼Ÿ\n\næª”æ¡ˆå°‡è¢«ç§»å‹•åˆ°å›æ”¶æ¡¶ï¼Œå¯ä»¥ç¨å¾Œé‚„åŸã€‚`;
                if (!confirm(confirmMessage)) return;

                const originalText = batchDelete.innerHTML;
                batchDelete.innerHTML = '<i class="bi bi-hourglass-split"></i> è™•ç†ä¸­...';
                batchDelete.disabled = true;

                fetch('/api/batch-delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filenames: filenames
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('æ‰¹é‡åˆªé™¤æ“ä½œå¤±æ•—ï¼š' + data.message);
                    }
                })
                .catch(error => {
                    console.error('æ‰¹é‡åˆªé™¤æ“ä½œå¤±æ•—:', error);
                    alert('æ‰¹é‡åˆªé™¤æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                })
                .finally(() => {
                    batchDelete.innerHTML = originalText;
                    batchDelete.disabled = false;
                });
            });
        }
    });
</script>
{% endblock %}
