{% extends "base.html" %}

{% block title %}任務佇列管理 - Whisper Web App{% endblock %}

{% block head %}
<style>
    .queue-status {
        background: var(--bg-card);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .task-card {
        border-left: 4px solid #007bff;
        margin-bottom: 15px;
        transition: all 0.3s ease;
        background-color: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        padding: 1rem;
    }
    .task-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .task-status-queued { border-left-color: #ffc107; }
    .task-status-processing { border-left-color: #17a2b8; }
    .task-status-completed { border-left-color: #28a745; }
    .task-status-failed { border-left-color: #dc3545; }
    .task-status-cancelled { border-left-color: #6c757d; }
    .task-priority {
        font-size: 0.8em;
        padding: 2px 6px;
        border-radius: 10px;
    }
    .priority-high { background-color: #dc3545; color: white; }
    .priority-medium { background-color: #ffc107; color: black; }
    .priority-low { background-color: #28a745; color: white; }
    .update-indicator {
        position: fixed;
        top: 80px;
        right: 20px;
        background: rgba(0, 123, 255, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }
    .update-indicator.show {
        opacity: 1;
    }
    .task-details {
        background-color: var(--bg-secondary);
        padding: 1rem;
        border-radius: 0.375rem;
        font-size: 0.9rem;
    }
    .task-details pre {
        background-color: var(--bg-card);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        margin-bottom: 0;
    }
    .task-card h6:hover {
        color: #0d6efd;
    }
</style>
{% endblock %}

{% block content %}
<!-- 更新指示器 -->
<div id="update-indicator" class="update-indicator">
    <i class="bi bi-arrow-clockwise"></i> 更新中...
</div>

<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="bi bi-list-task"></i> 任務佇列管理</h1>
        </div>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="autoRefreshSwitch" checked>
            <label class="form-check-label" for="autoRefreshSwitch">
                自動更新
            </label>
        </div>
    </div>
</div>

<!-- 佇列狀態總覽 -->
<div class="queue-status" id="queue-status">
    <div class="row text-center">
        <div class="col-md-2 col-6 mb-3 mb-md-0">
            <h4 id="total-tasks">0</h4>
            <small>總任務數</small>
        </div>
        <div class="col-md-2 col-6 mb-3 mb-md-0">
            <h4 id="queued-tasks" class="text-warning">0</h4>
            <small>排隊中</small>
        </div>
        <div class="col-md-2 col-6 mb-3 mb-md-0">
            <h4 id="processing-tasks" class="text-info">0</h4>
            <small>處理中</small>
        </div>
        <div class="col-md-2 col-6 mb-3 mb-md-0">
            <h4 id="completed-tasks" class="text-success">0</h4>
            <small>已完成</small>
        </div>
        <div class="col-md-2 col-6">
            <h4 id="failed-tasks" class="text-danger">0</h4>
            <small>失敗</small>
        </div>
        <div class="col-md-2 col-6">
            <h4 id="cancelled-tasks" class="text-secondary">0</h4>
            <small>已取消</small>
        </div>
    </div>
</div>

<!-- 過濾和操作 -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="statusFilter" class="form-label">狀態過濾</label>
                <select class="form-select" id="statusFilter">
                    <option value="">全部狀態</option>
                    <option value="queued">排隊中</option>
                    <option value="processing">處理中</option>
                    <option value="completed">已完成</option>
                    <option value="failed">失敗</option>
                    <option value="cancelled">已取消</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="searchInput" class="form-label">搜尋</label>
                <input type="text" class="form-control" id="searchInput" placeholder="搜尋任務...">
            </div>
            <div class="col-md-4">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="button" class="btn btn-primary" onclick="loadTasks()">
                        <i class="bi bi-arrow-clockwise"></i> 更新列表
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 任務列表 -->
<div class="card">
    <div class="card-header">
        <h5><i class="bi bi-list-ul"></i> 任務列表</h5>
    </div>
    <div class="card-body">
        <div id="loading-indicator" class="text-center py-4" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">載入中...</span>
            </div>
        </div>
        <div id="tasks-container">
            <!-- 任務將透過 JavaScript 動態載入 -->
        </div>
        <div id="no-tasks" class="empty-state" style="display: none;">
            <i class="bi bi-inbox"></i>
            <h3>沒有任務</h3>
            <p>目前沒有符合條件的任務</p>
        </div>
    </div>
</div>

<!-- 取消任務模態框 -->
<div class="modal fade" id="cancelTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">取消任務</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>確定要取消這個任務嗎？</p>
                <input type="hidden" id="cancelTaskId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="confirmCancelTask()">確認取消</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let autoRefreshInterval = null;
    let cancelTaskModal = null;

    document.addEventListener('DOMContentLoaded', function() {
        // 初始化 modal
        cancelTaskModal = new bootstrap.Modal(document.getElementById('cancelTaskModal'));

        // 載入任務
        loadTasks();

        // 自動更新開關
        const autoRefreshSwitch = document.getElementById('autoRefreshSwitch');
        if (autoRefreshSwitch) {
            autoRefreshSwitch.addEventListener('change', function() {
                if (this.checked) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });
            
            // 預設啟動自動更新
            if (autoRefreshSwitch.checked) {
                startAutoRefresh();
            }
        }

        // 過濾器
        document.getElementById('statusFilter').addEventListener('change', loadTasks);
        document.getElementById('searchInput').addEventListener('input', debounce(loadTasks, 500));
    });

    function startAutoRefresh() {
        stopAutoRefresh();
        autoRefreshInterval = setInterval(() => {
            loadTasks(true);
        }, 5000); // 每5秒更新
    }

    function stopAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }

    function showUpdateIndicator() {
        const indicator = document.getElementById('update-indicator');
        indicator.classList.add('show');
        setTimeout(() => {
            indicator.classList.remove('show');
        }, 1000);
    }

    async function loadTasks(silent = false) {
        if (!silent) {
            document.getElementById('loading-indicator').style.display = 'block';
        } else {
            showUpdateIndicator();
        }

        const statusFilter = document.getElementById('statusFilter').value;
        const searchTerm = document.getElementById('searchInput').value;

        try {
            // 獲取佇列狀態
            const statusResponse = await fetch('/api/queue/status');
            const statusResult = await statusResponse.json();

            // 獲取任務列表
            const listResponse = await fetch('/api/queue/list');
            const listResult = await listResponse.json();

            if (statusResult.success && listResult.success) {
                updateQueueStatus(statusResult.status);
                displayTasks(listResult.tasks || [], statusFilter, searchTerm);
            }
        } catch (error) {
            console.error('載入任務失敗:', error);
        } finally {
            document.getElementById('loading-indicator').style.display = 'none';
        }
    }

    function updateQueueStatus(status) {
        document.getElementById('total-tasks').textContent = status.total_tasks || 0;
        document.getElementById('queued-tasks').textContent = status.queued || 0;
        document.getElementById('processing-tasks').textContent = status.processing || 0;
        document.getElementById('completed-tasks').textContent = status.completed || 0;
        document.getElementById('failed-tasks').textContent = status.failed || 0;
        document.getElementById('cancelled-tasks').textContent = status.cancelled || 0;
    }

    function displayTasks(tasks, statusFilter, searchTerm) {
        const container = document.getElementById('tasks-container');
        const noTasks = document.getElementById('no-tasks');

        // 過濾任務
        let filteredTasks = tasks;
        if (statusFilter) {
            filteredTasks = filteredTasks.filter(task => task.status === statusFilter);
        }
        if (searchTerm) {
            const term = searchTerm.toLowerCase();
            filteredTasks = filteredTasks.filter(task => {
                const title = task.data?.title || task.data?.audio_url || '';
                return title.toLowerCase().includes(term) ||
                       task.task_id.toLowerCase().includes(term);
            });
        }

        if (filteredTasks.length === 0) {
            container.innerHTML = '';
            noTasks.style.display = 'block';
            return;
        }

        noTasks.style.display = 'none';
        container.innerHTML = filteredTasks.map(task => createTaskCard(task)).join('');
    }

    function createTaskCard(task) {
        const statusClass = `task-status-${task.status}`;
        const statusText = getStatusText(task.status);
        const statusBadge = getStatusBadge(task.status);
        
        // 從 data 中獲取標題
        const title = task.data?.title || task.data?.audio_url || task.task_id;
        const createdAt = task.created_at ? new Date(task.created_at).toLocaleString('zh-TW') : '';

        return `
            <div class="task-card ${statusClass}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1" style="cursor: pointer;" onclick="toggleTaskDetails('${task.task_id}')">
                        <h6 class="mb-2">
                            ${escapeHtml(title)}
                            <i class="bi bi-chevron-down ms-2" id="chevron-${task.task_id}"></i>
                        </h6>
                        <div class="mb-2">
                            <span class="badge ${statusBadge}">${statusText}</span>
                            ${task.priority ? `<span class="task-priority priority-${getPriorityLevel(task.priority)}">${task.priority}</span>` : ''}
                        </div>
                        <small class="text-muted">
                            <i class="bi bi-clock"></i> ${createdAt}
                            <span class="ms-2"><i class="bi bi-tag"></i> ${task.task_type}</span>
                        </small>
                        ${task.error_message ? `<div class="text-danger small mt-1"><i class="bi bi-exclamation-circle"></i> ${escapeHtml(task.error_message)}</div>` : ''}
                        
                        <!-- 任務詳情（預設隱藏） -->
                        <div id="details-${task.task_id}" class="task-details mt-3" style="display: none;">
                            <hr>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <strong>任務 ID:</strong> ${task.task_id}
                                </div>
                                <div class="col-md-6">
                                    <strong>優先級:</strong> ${task.priority}
                                </div>
                                ${task.started_at ? `
                                <div class="col-md-6">
                                    <strong>開始時間:</strong> ${new Date(task.started_at).toLocaleString('zh-TW')}
                                </div>
                                ` : ''}
                                ${task.completed_at ? `
                                <div class="col-md-6">
                                    <strong>完成時間:</strong> ${new Date(task.completed_at).toLocaleString('zh-TW')}
                                </div>
                                ` : ''}
                                ${task.user_ip ? `
                                <div class="col-md-6">
                                    <strong>來源 IP:</strong> ${task.user_ip}
                                </div>
                                ` : ''}
                                ${task.progress ? `
                                <div class="col-md-6">
                                    <strong>進度:</strong> ${task.progress}%
                                </div>
                                ` : ''}
                            </div>
                            ${task.data ? `
                            <div class="mt-2">
                                <strong>任務資料:</strong>
                                <pre class="bg-light p-2 rounded mt-1" style="font-size: 0.85rem; max-height: 200px; overflow-y: auto;">${JSON.stringify(task.data, null, 2)}</pre>
                            </div>
                            ` : ''}
                            ${task.result ? `
                            <div class="mt-2">
                                <strong>執行結果:</strong>
                                <pre class="bg-light p-2 rounded mt-1" style="font-size: 0.85rem; max-height: 200px; overflow-y: auto;">${JSON.stringify(task.result, null, 2)}</pre>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="btn-group btn-group-sm">
                        ${task.status === 'queued' || task.status === 'processing' ? 
                            `<button class="btn btn-outline-danger" onclick="event.stopPropagation(); showCancelTaskModal('${task.task_id}')">
                                <i class="bi bi-x-circle"></i> 取消
                            </button>` : ''}
                        ${task.status === 'failed' ? 
                            `<button class="btn btn-outline-warning" onclick="event.stopPropagation(); retryTask('${task.task_id}')">
                                <i class="bi bi-arrow-clockwise"></i> 重試
                            </button>` : ''}
                    </div>
                </div>
            </div>
        `;
    }

    function toggleTaskDetails(taskId) {
        const details = document.getElementById(`details-${taskId}`);
        const chevron = document.getElementById(`chevron-${taskId}`);
        
        if (details.style.display === 'none') {
            details.style.display = 'block';
            chevron.classList.remove('bi-chevron-down');
            chevron.classList.add('bi-chevron-up');
        } else {
            details.style.display = 'none';
            chevron.classList.remove('bi-chevron-up');
            chevron.classList.add('bi-chevron-down');
        }
    }

    function getPriorityLevel(priority) {
        if (priority <= 3) return 'high';
        if (priority <= 7) return 'medium';
        return 'low';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function getStatusText(status) {
        const statusMap = {
            'queued': '排隊中',
            'processing': '處理中',
            'completed': '已完成',
            'failed': '失敗',
            'cancelled': '已取消'
        };
        return statusMap[status] || status;
    }

    function getStatusBadge(status) {
        const badgeMap = {
            'queued': 'bg-warning text-dark',
            'processing': 'bg-info',
            'completed': 'bg-success',
            'failed': 'bg-danger',
            'cancelled': 'bg-secondary'
        };
        return badgeMap[status] || 'bg-secondary';
    }

    function showCancelTaskModal(taskId) {
        document.getElementById('cancelTaskId').value = taskId;
        cancelTaskModal.show();
    }

    async function confirmCancelTask() {
        const taskId = document.getElementById('cancelTaskId').value;
        
        try {
            const response = await fetch('/api/queue/cancel', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ task_id: taskId })
            });

            const result = await response.json();
            if (result.success) {
                cancelTaskModal.hide();
                loadTasks();
            } else {
                alert('取消任務失敗：' + result.message);
            }
        } catch (error) {
            console.error('取消任務失敗:', error);
            alert('取消任務失敗，請稍後再試');
        }
    }

    async function retryTask(taskId) {
        if (!confirm('確定要重試這個任務嗎？')) return;

        try {
            const response = await fetch('/api/queue/restart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ task_id: taskId })
            });

            const result = await response.json();
            if (result.success) {
                loadTasks();
            } else {
                alert('重試任務失敗：' + result.message);
            }
        } catch (error) {
            console.error('重試任務失敗:', error);
            alert('重試任務失敗，請稍後再試');
        }
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // 頁面卸載時停止自動更新
    window.addEventListener('beforeunload', stopAutoRefresh);
</script>
{% endblock %}
