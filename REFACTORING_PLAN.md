# Python 程式碼重構執行計畫

本文件旨在提供一個結構化、系統性的 Python 程式碼重構流程，以提升專案的程式碼品質、可維護性與擴展性。

---

## 第一階段：分析與評估 (Analysis & Assessment)

**目標：** 全面理解現有程式碼庫的結構、風格與潛在問題，為後續重構建立基準。

**步驟：**

1.  **掃描專案結構：**
    *   使用 `ls -R` 或類似工具，繪製出專案的目錄與檔案結構圖。
    *   識別核心應用程式邏輯、設定檔、測試檔案與輔助工具。

2.  **識別核心模組與其職責：**
    *   閱讀主要模組的程式碼 (例如 `app.py`, `whisper_manager.py`, `ai_summary_service.py`)。
    *   初步判斷每個模組是否符合「單一職責原則」。

3.  **建立測試覆蓋率基準：**
    *   如果專案已有測試，執行測試並記錄覆蓋率報告。
    *   如果缺乏測試，此階段的目標是識別出最關鍵、最需要測試保護的業務 logique。

4.  **程式碼品質靜態分析：**
    *   使用 `pylint`, `flake8` 或 `ruff` 等工具對整個專案進行掃描。
    *   記錄下重複程式碼、過長函數、複雜度過高的區塊等問題。

---

## 第二階段：規劃與優先級排序 (Planning & Prioritization)

**目標：** 根據分析結果，定義具體的重構目標，並排列執行的優先順序。

**步驟：**

1.  **識別程式碼 "壞味道" (Code Smells)：**
    *   基於第一階段的分析，列出具體的程式碼問題清單。例如：
        *   **重複的程式碼 (Duplicated Code):** 在不同模組中是否有相似的邏輯？
        *   **過長的函數 (Long Method):** 函數是否超過 20-30 行？是否能被拆解？
        *   **巨大的類別 (Large Class):** 類別是否承擔了過多職責？
        *   **過長的參數列表 (Long Parameter List):** 函數參數是否過多？能否用物件封裝？
        *   **全域變數與狀態共享：** 是否存在濫用全域變數，導致狀態管理混亂？

2.  **應用 SOLID 設計原則進行評估：**
    *   **單一職責 (SRP):** `app.py` 是否處理了太多無關的事情（例如，路由、業務邏輯、SocketIO 管理）？
    *   **開閉原則 (OCP):** 如果要新增一種新的 AI 模型或任務類型，是否需要大量修改現有程式碼？
    *   **依賴反轉 (DIP):** 高層模組（如 `app.py`）是否直接依賴於低層模組的具體實現（如 `WhisperManager`）？

3.  **制定分步重構計畫：**
    *   從最明顯、風險最低的問題開始著手。
    *   將大型重構任務拆解為一系列小步驟。
    *   **範例計畫：**
        1.  **重構 `utils.py`:** 將通用函數整理分類。
        2.  **重構 `config.py`:** 建立一個專門的設定管理類別，取代全域字典。
        3.  **重構 `app.py`:** 將 SocketIO 邏輯、路由邏輯、任務管理邏輯分離到各自的模組。
        4.  **為 `WhisperManager` 增加單元測試。**

---

## 第三階段：漸進式重構與測試 (Incremental Refactoring & Testing)

**目標：** 安全、小步地執行重構，並確保每一步都有測試支持，避免破壞現有功能。

**步驟：**

1.  **先寫測試，再進行重構：**
    *   針對你計畫重構的程式碼區塊，先編寫單元測試或整合測試，確保其行為被完整捕捉。
    *   執行測試，確認它們在重構前可以通過。

2.  **應用重構技巧 (一次只做一件事)：**
    *   **提取函數 (Extract Method):** 將過長函數中的邏輯塊提取成獨立、命名良好的小函數。
    *   **提取類別 (Extract Class):** 當一個類別職責過多時，將相關的變數和函數提取到新的類別中。
    *   **移動函數/變數 (Move Method/Field):** 將函數或變數移動到更適合它們的類別。
    *   **用多型取代條件判斷 (Replace Conditional with Polymorphism):** 如果有基於類型或狀態的複雜 `if/else` 或 `switch`，考慮使用策略模式或狀態模式。

3.  **頻繁執行測試：**
    *   每完成一個微小的改動（例如，提取一個函數），就立刻執行相關的測試。
    *   確保測試通過後，再進行下一步。

4.  **版本控制：**
    *   使用 Git 進行版本控制，每個成功的重構步驟都應該是一個獨立的 commit。
    *   Commit message 應清晰描述重構的「目的」與「做法」。

---

## 第四階段：審查與定稿 (Review & Finalization)

**目標：** 確保重構達到了預期目標，程式碼品質獲得提升，且沒有引入新的問題。

**步驟：**

1.  **程式碼審查 (Code Review)：**
    *   邀請同事或其他開發者審查你的重構變更。
    *   解釋你的重構思路，並討論是否有更好的作法。

2.  **效能與整合測試：**
    *   執行完整的整合測試，確保系統在重構後依然能正常運作。
    *   如有必要，進行效能測試，確保重構沒有引入效能瓶頸。

3.  **更新文件與註解：**
    *   如果重構改變了類別的 API、模組的職責或專案的架構，務必更新相關的 README、API 文件或程式碼註解。

4.  **合併程式碼：**
    *   在所有測試與審查都通過後，將重構分支合併回主分支。
