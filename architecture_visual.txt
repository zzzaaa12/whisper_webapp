┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Whisper WebApp 系統架構圖                              │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                               外部介面層                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                          │
│  │ Web 瀏覽器   │    │ Python      │    │ Telegram    │                          │
│  │             │    │ Client      │    │ Bot         │                          │
│  │ 使用者介面    │    │ API 客戶端   │    │ 通知系統     │                          │
│  └─────────────┘    └─────────────┘    └─────────────┘                          │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                API 層                                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                          │
│  │ Flask Web   │    │ Socket.IO   │    │ REST API    │                          │
│  │ Server      │    │ Server      │    │ /api/process│                          │
│  │             │    │             │    │             │                          │
│  │ HTTP 路由    │    │ 即時通訊     │    │ JSON API    │                          │
│  └─────────────┘    └─────────────┘    └─────────────┘                          │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              業務邏輯層                                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      │
│  │ 任務佇列     │    │ 狀態管理     │    │ 登入驗證     │    │ IP 封鎖      │      │
│  │ 管理        │    │             │    │             │    │ 管理        │      │
│  │             │    │ 伺服器狀態   │    │ 通行碼驗證   │    │             │      │
│  │ 任務排程     │    │ 追蹤        │    │ 嘗試限制     │    │ 封鎖機制     │      │
│  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘      │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                             背景處理層                                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      │
│  │ 背景工作     │    │ YouTube     │    │ Whisper     │    │ OpenAI      │      │
│  │ 程序        │    │ 下載器       │    │ 轉錄引擎     │    │ 摘要引擎     │      │
│  │             │    │             │    │             │    │             │      │
│  │ 任務執行     │    │ 音檔下載     │    │ 語音轉文字   │    │ AI 摘要生成   │      │
│  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘      │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              資料儲存層                                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      │
│  │ 音檔儲存     │    │ 字幕檔案     │    │ 摘要檔案     │    │ 日誌檔案     │      │
│  │             │    │             │    │             │    │             │      │
│  │ downloads/  │    │ subtitles/  │    │ summaries/  │    │ logs/       │      │
│  │ (自動清理)   │    │ .srt 格式    │    │ .txt 格式    │    │ 操作記錄     │      │
│  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘      │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              外部服務                                             │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                          │
│  │ YouTube     │    │ OpenAI API  │    │ Telegram    │                          │
│  │             │    │             │    │ API         │                          │
│  │ 影片下載     │    │ GPT-4 摘要   │    │ 通知發送     │                          │
│  └─────────────┘    └─────────────┘    └─────────────┘                          │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              資料流程圖                                           │
└─────────────────────────────────────────────────────────────────────────────────┘

使用者 → Web介面 → API檢查 → 佇列管理 → 背景處理 → 外部服務 → 檔案儲存
   │         │         │         │         │         │         │
   ▼         ▼         ▼         ▼         ▼         ▼         ▼
輸入URL   表單驗證   狀態檢查   任務排程   下載音檔   YouTube   音檔儲存
   │         │         │         │         │         │         │
   ▼         ▼         ▼         ▼         ▼         ▼         ▼
通行碼    即時日誌   忙碌/空閒   開始處理   轉錄音檔   OpenAI   字幕儲存
   │         │         │         │         │         │         │
   ▼         ▼         ▼         ▼         ▼         ▼         ▼
狀態回饋   進度更新   任務ID     執行任務   生成摘要   Telegram  摘要儲存
   │         │         │         │         │         │         │
   ▼         ▼         ▼         ▼         ▼         ▼         ▼
完成通知   結果顯示   清理資源   完成處理   發送通知   通知完成   自動清理

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              技術架構                                             │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Python 3.12 │    │ Flask       │    │ Socket.IO   │    │ Faster      │
│             │    │ Framework   │    │             │    │ Whisper     │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │                   │
       ▼                   ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ PyTorch     │    │ yt-dlp      │    │ OpenAI API  │    │ Telegram    │
│ + CUDA      │    │             │    │             │    │ Bot API     │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              部署架構                                             │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 主程序       │    │ 背景程序     │    │ 佇列監聽器   │    │ 多執行緒     │
│             │    │             │    │             │    │             │
│ Flask       │    │ Worker      │    │ Queue       │    │ Socket.IO   │
│ Server      │    │ Process     │    │ Listener    │    │ Threading   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              安全架構                                             │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 網路層安全   │    │ 應用層安全   │    │ 資料層安全   │    │ 監控機制     │
│             │    │             │    │             │    │             │
│ IP 封鎖     │    │ 通行碼驗證   │    │ 檔案路徑     │    │ 登入記錄     │
│ 系統        │    │ 嘗試限制     │    │ 驗證        │    │ 操作日誌     │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              狀態管理                                             │
└─────────────────────────────────────────────────────────────────────────────────┘

空閒狀態 ──→ 接收請求 ──→ 驗證通行碼 ──→ 加入佇列 ──→ 忙碌狀態
    ↑                                                      │
    │                                                      ▼
    └── 完成處理 ←── 生成摘要 ←── 轉錄音檔 ←── 下載音檔 ←──┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              功能特色                                             │
└─────────────────────────────────────────────────────────────────────────────────┘

✅ 多層架構設計：從外部介面到資料儲存的分層設計
✅ 模組化功能：每個功能模組都有明確的職責
✅ 安全機制：完整的安全驗證和監控系統
✅ 可擴展性：支援多種介面（Web、API、Client）
✅ 可靠性：錯誤處理和狀態管理機制
✅ 效能優化：背景處理和快取機制
✅ 即時通訊：Socket.IO 即時狀態更新
✅ 自動清理：音檔處理完成後自動刪除
✅ 通知系統：Telegram 完成通知
✅ 取消功能：支援任務取消操作 